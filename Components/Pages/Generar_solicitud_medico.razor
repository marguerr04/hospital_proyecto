@page "/generar_solicitud_medico"
@layout Components.Layout.MainLayoutMedico
@using proyecto_hospital_version_1.Data.Hospital
@inject HospitalDbContext HospitalDb
@using Microsoft.EntityFrameworkCore

<PageTitle>Nueva Solicitud Quirúrgica</PageTitle>

<div class="solicitud-container">
    <div class="row">
        <!-- Columna Izquierda Principal (Contiene todo el flujo) -->
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Nueva Solicitud Quirúrgica</h1>

            <!-- Navegación por pasos -->
            <nav class="nav nav-pills nav-fill mb-4">
                <a class="nav-link active" href="#">1) Contexto y Consentimiento</a>
            </nav>

            <!-- SECCIÓN DE BÚSQUEDA DE PACIENTES (Ahora dentro de su propia tarjeta) -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- Controles de búsqueda -->
                    <div class="row">
                        <div class="col-md-6">
                            <label>Buscar por rut sin puntos ni digito veríficador:</label>
                            <input type="text"
                                   class="form-control"
                                   placeholder="Buscar..."
                                   @bind="_busquedaTexto"
                                   @bind:event="oninput"
                                   @onkeypress="@(async (e) => { if (e.Key == "Enter") await CargarPacientes(); })" />
                        </div>
                        <div class="col-md-3">
                            <label>DV:</label>
                            <input type="text"
                                   class="form-control text-center"
                                   placeholder="K"
                                   maxlength="1"
                                   @bind="_busquedaDv"
                                   @bind:event="oninput"
                                   style="text-transform: uppercase;" />
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <div>
                                <button class="btn btn-success w-100" @onclick="CargarPacientes">
                                    Buscar
                                </button>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(_busquedaTexto) || !string.IsNullOrWhiteSpace(_busquedaDv))
                    {
                        <div class="alert alert-info mt-3">
                            <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="LimpiarBusqueda">Limpiar</button>
                        </div>
                    }
                </div>
            </div>

            <!-- Tarjeta Principal de Contenido (Diagnóstico y Consentimiento) -->
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <!-- ===== INICIO DEL CAMBIO IMPORTANTE ===== -->
                    <div class="info-paciente mb-4">
                        <strong>Paciente:</strong> @_nombrePacienteParaMostrar - <strong>RUT:</strong> @_rutPacienteParaMostrar
                    </div>
                    <!-- ===== FIN DEL CAMBIO IMPORTANTE ===== -->

                    <h5 class="mb-3 border-bottom pb-2">1. Procedencia y Diagnóstico</h5>

                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="procedencia" id="btn-ambulatorio" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="btn-ambulatorio">Ambulatorio/CRS</label>

                        <input type="radio" class="btn-check" name="procedencia" id="btn-hospitalizado" autocomplete="off">
                        <label class="btn btn-outline-primary" for="btn-hospitalizado">Hospitalizado</label>

                        <input type="radio" class="btn-check" name="procedencia" id="btn-urgencia" autocomplete="off">
                        <label class="btn btn-outline-primary" for="btn-urgencia">Urgencia</label>
                    </div>

                    <div class="mb-4">
                        <label for="diagnostico" class="form-label">Diagnóstico Principal (CIE-10)</label>
                        <input type="text" class="form-control" id="diagnostico" placeholder="Ej: Colelitiasis">
                    </div>

                    <h5 class="mb-3 border-bottom pb-2">2. Consentimiento Informado</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="consentimientoCheck" checked>
                            <label class="form-check-label" for="consentimientoCheck">
                                Se confirma que el consentimiento informado fue discutido y aceptado por el paciente.
                            </label>
                        </div>
                        <button class="btn btn-success">
                            <i class="bi bi-file-earmark-pdf-fill me-2"></i> Generar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botones de Navegación -->
            <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-secondary me-2" disabled>← Anterior</button>
                <button class="btn btn-primary">Siguiente →</button>
            </div>
        </div>

        <!-- Columna Derecha (Alertas) - No se modifica -->
        <div class="col-lg-4">
            <div class="card alert-widget-sticky">
                <div class="card-body">
                    <h5 class="card-title mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i> Alertas Clínicas Clave</h5>
                    <p class="alert-item ges">⚠️ Paciente GES</p>
                    <p class="alert-item alergia">❗ Alergia a Penicilina</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .alert-widget-sticky {
        position: sticky;
        top: 20px;
    }

    .info-paciente {
        font-size: 0.95rem;
    }

    .solicitud-container {
        padding: 20px;
    }
</style>

@code {
    // Variables existentes
    private int? NumeroBusqueda { get; set; }
    private string TextoBusqueda { get; set; } = string.Empty;

    // Variables para búsqueda de pacientes
    private List<PacienteHospital> _pacientes = new();
    private string _estado = "inicial";
    private string? _error;
    private int _cantidadMostrar = 10;
    private int _totalPacientes = 0;
    private string _busquedaTexto = "";
    private string _busquedaDv = "";


    private string _nombrePacienteParaMostrar = "";
    private string _rutPacienteParaMostrar = "";



    protected override async Task OnInitializedAsync()
    {
        await Task.CompletedTask;
    }

    private async Task CargarPacientes()
    {
        if (string.IsNullOrWhiteSpace(_busquedaTexto) && string.IsNullOrWhiteSpace(_busquedaDv))
        {
            return;
        }
        _estado = "cargando";
        StateHasChanged();

        try
        {
            var query = HospitalDb.Pacientes.AsQueryable();

            if (!string.IsNullOrWhiteSpace(_busquedaTexto))
            {
                var busqueda = _busquedaTexto.ToLower();
                query = query.Where(p =>
                    p.primerNombre.ToLower().Contains(busqueda) ||
                    (p.segundoNombre != null && p.segundoNombre.ToLower().Contains(busqueda)) ||
                    p.apellidoPaterno.ToLower().Contains(busqueda) ||
                    (p.apellidoMaterno != null && p.apellidoMaterno.ToLower().Contains(busqueda)) ||
                    p.rut.Contains(busqueda)
                );
            }

            if (!string.IsNullOrWhiteSpace(_busquedaDv))
            {
                var dvUpper = _busquedaDv.ToUpper();
                query = query.Where(p => p.dv.ToUpper() == dvUpper);
            }


            var pacienteEncontrado = await query.FirstOrDefaultAsync();

            if (pacienteEncontrado != null)
            {

                _nombrePacienteParaMostrar = $"{pacienteEncontrado.primerNombre} {pacienteEncontrado.apellidoPaterno}";
                _rutPacienteParaMostrar = $"{pacienteEncontrado.rut}-{pacienteEncontrado.dv}";
            }
            else
            {
                // Si no se encuentra, mostramos un mensaje indicándolo.
                _nombrePacienteParaMostrar = "Paciente no encontrado";
                _rutPacienteParaMostrar = "";
            }
            // ===== FIN DEL CAMBIO IMPORTANTE =====

            _estado = "ok";
        }
        catch (Exception ex)
        {
            _estado = "error";
            _error = ex.Message;
            Console.WriteLine($"Error al buscar pacientes: {ex}");
        }

        StateHasChanged();
    }

    private async Task BuscarPacientes()
    {
        await CargarPacientes();
    }

    private async Task LimpiarBusqueda()
    {
        _busquedaTexto = "";
        _busquedaDv = "";
        _pacientes.Clear();
        _estado = "inicial";


        _nombrePacienteParaMostrar = "";
        _rutPacienteParaMostrar = "";


        StateHasChanged();
    }

    private void SeleccionarPaciente(PacienteHospital paciente)
    {
        Console.WriteLine($"Paciente seleccionado: {paciente.primerNombre} {paciente.apellidoPaterno}");
    }

    private void Buscar()
    {
        Console.WriteLine($"Número ingresado: {NumeroBusqueda}");
        Console.WriteLine($"Texto ingresado: {TextoBusqueda}");
    }
}
