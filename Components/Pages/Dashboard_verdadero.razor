@page "/dashboard_verdadero"
@inject proyecto_hospital_version_1.Data.DashboardService dashboard
@using MudBlazor
@using proyecto_hospital_version_1.Data

<PageTitle>Panel de Control - Gestión Clínica</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
        🏥 Seguimiento Percentil 75 LE IQ NO GES
    </MudText>
    <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-4 text-secondary">
        Unidad de Control de Gestión · @DateTime.Now.ToString("dd.MM.yyyy")
    </MudText>

    <!-- Tarjetas de Resumen -->
    <MudGrid>
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4 text-center" Elevation="3">
                <MudText Typo="Typo.h6" Class="text-primary">Percentil 75</MudText>
                <MudText Typo="Typo.h3">@Percentil75</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4 text-center" Elevation="3">
                <MudText Typo="Typo.h6" Class="text-error">Reducción</MudText>
                <MudProgressCircular Value="46.2" Size="Size.Large" Color="Color.Error" />
                <MudText Typo="Typo.h5">@Reduccion</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4 text-center" Elevation="3">
                <MudText Typo="Typo.h6" Class="text-info">Pendientes</MudText>
                <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large" Color="Color.Info" />
                <MudText Typo="Typo.h4">@Pendientes</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-6" />

    <!-- Ejemplo de gráfico -->
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6">Estado del caso</MudText>
                <MudChart ChartType="ChartType.Bar" Labels="@EstadoLabels" Datasets="@EstadoDatos" />
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6">Contactabilidad</MudText>
                <MudChart ChartType="ChartType.Donut" Labels="@ContactoLabels" Datasets="@ContactoDatos" />
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int Percentil75;
    private int Reduccion;
    private int Pendientes;

    private string[] EstadoLabels = { "Programado", "En espera", "Finalizado" };
    private List<ChartSeries> EstadoDatos = new()
    {
        new ChartSeries() { Name = "Casos", Data = new double[] { 12, 8, 20 } }
    };

    private string[] ContactoLabels = { "Contactado", "En proceso", "No contactado" };
    private List<ChartSeries> ContactoDatos = new()
    {
        new ChartSeries() { Name = "Porcentaje", Data = new double[] { 66.4, 20.0, 13.6 } }
    };

    protected override async Task OnInitializedAsync()
    {
        Percentil75 = await dashboard.ObtenerPercentil75Async();
        Reduccion = await dashboard.ObtenerReduccionAsync();
        Pendientes = await dashboard.ObtenerPendientesAsync();

        // Refresca cada 10 segundos
        var timer = new System.Threading.Timer(async _ =>
        {
            Percentil75 = await dashboard.ObtenerPercentil75Async();
            Reduccion = await dashboard.ObtenerReduccionAsync();
            Pendientes = await dashboard.ObtenerPendientesAsync();
            await InvokeAsync(StateHasChanged);
        }, null, 0, 10000);
    }
}
