@using proyecto_hospital_version_1.Models

<div class="card shadow-sm mb-4">
    <div class="card-body p-4">
    <div class="alert alert-primary p-3 mb-4 d-flex align-items-center" style="--bs-alert-bg: #e0f2f7; --bs-alert-color: #0c5460; border-color: #bee5eb;">
            <i class="bi bi-file-medical-fill me-3 h4 mb-0"></i> <h5 class="mb-0">3 Requerimientos y generación de solicitud</h5>
    </div>
    <div class="card-body p-4">

        @if (Paciente != null)
        {
            <div class="info-resumen mb-4 p-3 border rounded bg-light">
                <h6>Resumen</h6>
                <div class="row small">

                    <!-- AÑADE ESTAS LÍNEAS PARA DEBUG -->
                    <div class="col-md-6">
                        <strong>Paciente:</strong> @(Paciente?.primerNombre) @(Paciente?.apellidoPaterno)
                    </div>
                    <div class="col-md-6">
                        <strong>RUT:</strong> @(Paciente?.rut)-@(Paciente?.dv)
                    </div>







                    <div class="col-md-6">
                        <strong>Diagnóstico Principal:</strong> @DiagnosticoPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>Origen:</strong> @ProcedenciaPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>Procedimiento Solicitado:</strong> @ProcedimientoPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>GES:</strong> @(EsGes ? "Sí" : "No")
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 border-end pe-4"> 

                    @* Aqui ira el componente de selector de equipos *@

                    <SelectorEquipos @bind-EquiposSeleccionados="EquiposSeleccionados"
                                     OpcionesEquipos="OpcionesEquipos" />



                    <h6 class="mb-3 border-bottom pb-2">Tipo de mesa quirúrgica</h6>
                    <div class="mb-4">
                        <div class="form-check form-check-inline">
                            <input type="radio" class="form-check-input" name="tipoMesa" id="mesa-estandar"
                                   @onchange="@(() => SeleccionarTipoMesa("Estándar General"))"
                                   checked="@(TipoMesaSeleccionado == "Estándar General")">
                            <label class="form-check-label" for="mesa-estandar">Estándar General</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="radio" class="form-check-input" name="tipoMesa" id="mesa-especial"
                                   @onchange="@(() => SeleccionarTipoMesa("Especial (Traumatología)"))"
                                   checked="@(TipoMesaSeleccionado == "Especial (Traumatología)")">
                            <label class="form-check-label" for="mesa-especial">Especial (Traumatología)</label>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 ps-4"> @* Columna derecha para las evaluaciones y planificación*@
                    <h6 class="mb-3 border-bottom pb-2">Evaluaciones pre-operatorias</h6>
                    <div class="mb-4">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="evaluacionAnestesica"
                                   checked="@EvaluacionAnestesica" @onchange="OnEvaluacionAnestesicaChanged">
                            <label class="form-check-label" for="evaluacionAnestesica">Evaluación anestésica</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="transfusiones"
                                   checked="@Transfusiones" @onchange="OnTransfusionesChanged">
                            <label class="form-check-label" for="transfusiones">Transfusiones</label>
                        </div>
                    </div>

                    <h6 class="mb-3 border-bottom pb-2">Planificación Quirúrgica</h6>
                    <div class="row mb-4 align-items-end">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <label for="salaOperaciones" class="form-label visually-hidden">Sala de operaciones</label>
                            <select class="form-select" id="salaOperaciones"
                                    value="@SalaOperaciones"
                                    @onchange="OnSalaOperacionesChanged">
                                <option value="">Sala de operaciones</option>
                                <option value="Sala 1">Sala 1</option>
                                <option value="Sala 2">Sala 2</option>
                                <option value="Sala 3">Sala 3</option>
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label for="tiempoEstimado" class="form-label visually-hidden">Tiempo estimado cirugías</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="tiempoEstimado"
                                       placeholder="Tiempo estimado cirugías"
                                       value="@TiempoEstimado"
                                       @onchange="OnTiempoEstimadoChanged"
                                       min="0">

                                    @*
                                <span class="input-group-text p-0 border-0"> @* Contenedor para el icono de filtro y el texto "Minutos" 

                                    <button type="button" class="btn btn-dark d-flex align-items-center justify-content-center" style="border-radius: 0.25rem 0 0 0.25rem; height: 100%;">
                                        <i class="bi bi-funnel-fill"></i> @* Icono de filtro para poder ajustar en base a minutos u horas
                                    </button>
                                </span>
                *@
                                <span class="input-group-text">Minutos</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <hr class="my-4" /> @* Para separar 2 secciones *@

            <h6 class="mb-3 border-bottom pb-2">Comorbilidades y comentarios</h6>
            <div class="d-flex flex-wrap gap-2 mb-3">
                @foreach (var comorbilidad in ComorbilidadesSeleccionadas)
                {
                    <span class="badge bg-primary text-dark p-2">
                        @comorbilidad <button type="button" class="btn-close btn-close-white ms-1" aria-label="Cerrar" @onclick="() => RemoverComorbilidad(comorbilidad)"></button>
                    </span>
                }
                    <button class="btn btn-outline-primary  btn-sm" @onclick="AbrirModalComorbilidades">
                    <i class="bi bi-plus-circle me-1"></i> Añadir Comorbilidades
                </button>



            </div>

            <div class="mb-4">
                <label for="comentariosAdicionales" class="form-label">Comentarios Adicionales</label>
                <textarea class="form-control" id="comentariosAdicionales" rows="3"
                          value="@ComentariosAdicionales"
                          @oninput="OnComentariosAdicionalesChanged"></textarea>
            </div>

        }
        else
        {
            <div class="alert alert-warning">
                No hay paciente seleccionado para este paso. Por favor, regrese al paso anterior.
            </div>
        }
    </div>
</div>

@* Ventanar emergentes o pop-ups, se deben cmabiar en el proximo commit para qeu esten bien posicionados*@





<div class="modal @(MostrarModalComorbilidades ? "show d-block" : "")" tabindex="-1" role="dialog" @onclick="CerrarModalComorbilidades">
    <div class="modal-dialog" role="document" @onclick:stopPropagation="true">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Añadir Comorbilidades</h5>
                <button type="button" class="btn-close" @onclick="CerrarModalComorbilidades" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @foreach (var comorbilidad in OpcionesComorbilidades)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="comorb@(comorbilidad.Replace(" ", "-").Replace("(", "").Replace(")", ""))"
                               @onchange='@((e) => ToggleComorbilidadDesdeModal(comorbilidad, (bool)e.Value))'
                               checked='@ComorbilidadesSeleccionadas.Contains(comorbilidad)'>
                        <label class="form-check-label" for="comorb@(comorbilidad.Replace(" ", "-").Replace("(", "").Replace(")", ""))">@comorbilidad</label>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" @onclick="CerrarModalComorbilidades">Listo</button>
            </div>
        </div>
    </div>
    </div>
</div>