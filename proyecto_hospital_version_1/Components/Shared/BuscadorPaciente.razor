@* Components/Shared/BuscadorPaciente.razor *@
@using proyecto_hospital_version_1.Services
@using proyecto_hospital_version_1.Data._Legacy
@inject IPacienteService PacienteService

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-5">
                <label class="form-label">RUT (sin puntos)</label>
                <input type="text" class="form-control" @bind="_rutBusqueda" />
            </div>
            <div class="col-md-2">
                <label class="form-label">DV</label>
                <input type="text" class="form-control text-center" maxlength="1" @bind="_dvBusqueda" style="text-transform: uppercase;" />
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" @onclick="Buscar">Buscar</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" @onclick="Limpiar">Limpiar</button>
            </div>
        </div>
        @if (!string.IsNullOrEmpty(_mensajeBusqueda))
        {
            <div class="alert @(_pacienteEncontrado ? "alert-success" : "alert-warning") mt-3 mb-0">
                @_mensajeBusqueda
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<PacienteHospital?> OnPacienteEncontrado { get; set; }
    private string _rutBusqueda = "";
    private string _dvBusqueda = "";
    private string _mensajeBusqueda = "";
    private bool _pacienteEncontrado = false;

    private async Task Buscar()
    {
        _mensajeBusqueda = "Buscando...";
        var paciente = await PacienteService.BuscarPacientePorRutAsync(_rutBusqueda, _dvBusqueda);

        if (paciente != null)
        {
            _pacienteEncontrado = true;
            _mensajeBusqueda = $"Paciente encontrado: {paciente.primerNombre} {paciente.apellidoPaterno}";
            await OnPacienteEncontrado.InvokeAsync(paciente);
        }
        else
        {
            _pacienteEncontrado = false;
            _mensajeBusqueda = "Paciente no encontrado.";
            await OnPacienteEncontrado.InvokeAsync(null);
        }
    }

    private async Task Limpiar()
    {
        _rutBusqueda = "";
        _dvBusqueda = "";
        _mensajeBusqueda = "";
        _pacienteEncontrado = false;
        await OnPacienteEncontrado.InvokeAsync(null);
    }
}