@* Components/Shared/BuscadorProfesional.razor *@
@using Hospital.Api.DTOs
@using proyecto_hospital_version_1.Services
@inject IProfesionalApiService ProfesionalApi

<div class="row g-2 align-items-end">
    <div class="col-md-7">
        <label class="form-label fw-semibold small">RUT (sin puntos)</label>
        <input type="text"
               class="form-control form-control-sm"
               placeholder="Ej: 12345678"
               value="@_rutBusqueda"
               @oninput="RutInputChanged"
               @onkeypress="OnKeyPress" />
    </div>
    <div class="col-md-2">
        <label class="form-label fw-semibold small">DV</label>
        <input type="text"
               class="form-control form-control-sm text-center text-uppercase"
               placeholder="K"
               maxlength="1"
               @bind="_dvBusqueda"
               @bind:event="oninput"
               @onkeypress="OnKeyPress"
               style="text-transform: uppercase;" />
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary btn-sm w-100"
                @onclick="Limpiar">
            <i class="bi bi-x-circle me-1"></i>
            Limpiar
        </button>
    </div>
</div>

@if (!string.IsNullOrEmpty(_mensajeBusqueda))
{
    <div class="alert @(_profesionalEncontrado ? "alert-success" : "alert-warning") alert-sm mt-2 mb-0 py-2">
        <small>
            <i class="bi @(_profesionalEncontrado ? "bi-check-circle" : "bi-exclamation-triangle") me-1"></i>
            @_mensajeBusqueda
        </small>
    </div>
}

@code {
    [Parameter]
    public EventCallback<ProfesionalDto?> OnProfesionalEncontrado { get; set; }

    [Parameter]
    public EventCallback<string> OnRutCambiado { get; set; }

    private string _rutBusqueda = "";
    private string _dvBusqueda = "";
    private string _mensajeBusqueda = "";
    private bool _profesionalEncontrado = false;

    private async Task Limpiar()
    {
        _rutBusqueda = "";
        _dvBusqueda = "";
        _mensajeBusqueda = "";
        _profesionalEncontrado = false;
        await OnProfesionalEncontrado.InvokeAsync(null);
        await OnRutCambiado.InvokeAsync(""); // Emitir cadena vacía para mostrar todos
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_rutBusqueda))
        {
            // Puedes agregar lógica adicional aquí si es necesario
            await Task.CompletedTask;
        }
    }

    private async Task RutInputChanged(ChangeEventArgs e)
    {
        _rutBusqueda = e.Value?.ToString() ?? "";

        // Filtrado en tiempo real: emitir el evento siempre
        await OnRutCambiado.InvokeAsync(_rutBusqueda);

        // Limpiar mensaje si está vacío
        if (string.IsNullOrWhiteSpace(_rutBusqueda))
        {
            _mensajeBusqueda = "";
            _profesionalEncontrado = false;
        }
    }
}