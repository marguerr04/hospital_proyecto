@using Microsoft.AspNetCore.Components
@using proyecto_hospital_version_1.Services
@using proyecto_hospital_version_1.Models
@using Hospital.Api.DTOs


<div class="mb-4 p-3 bg-light border rounded">
    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-list-check me-2 text-primary"></i> Procedimientos secundarios a realizar</h6>

    <div class="mb-3">
        <div class="input-group">
            <input class="form-control"
                   placeholder="Buscar procedimiento por nombre o código"
                   value="@_textoBusqueda"
                   @oninput="OnTextoChanged"
                   @onkeydown="OnKeyDown" />
            <button class="btn btn-outline-secondary" @onclick="Buscar">Buscar</button>
            <button class="btn btn-primary" @onclick="AgregarSeleccionado" disabled="@(_seleccionActual == null)"><i class="bi bi-plus-circle me-1"></i> Añadir</button>
        </div>
        @if (_sugerencias?.Any() == true)
        {
            <ul class="list-group mt-2">
                @foreach (var s in _sugerencias)
                {
                    <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" @onclick="(() => SeleccionarSugerencia(s))" style="cursor:pointer">
                        <span><strong>@s.Codigo</strong> - @s.Nombre</span>
                        <span class="text-muted small">Click para seleccionar</span>
                    </li>
                }
            </ul>
        }
        @if (_seleccionActual != null)
        {
            <div class="mt-2 text-muted small">Seleccionado: <strong>@_seleccionActual.Codigo</strong> - @_seleccionActual.Nombre</div>
        }
    </div>

    @if (Procedimientos.Any())
    {
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th style="width:110px">Código</th>
                        <th>Nombre</th>
                        <th style="width:110px">Orden</th>
                        <th>Observaciones</th>
                        <th style="width:170px" class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in Procedimientos)
                    {
                        var enEdicion = _editandoId == p.ProcedimientoId;
                        <tr>
                            <td>@p.Codigo</td>
                            <td>@p.Nombre</td>
                            <td style="max-width:110px">
                                @if (enEdicion)
                                {
                                    <input class="form-control form-control-sm" type="number" min="1" value="@p.Orden" @onchange="(e => CambiarOrden(p, e))" />
                                }
                                else
                                {
                                    <span>@p.Orden</span>
                                }
                            </td>
                            <td>
                                @if (enEdicion)
                                {
                                    <input class="form-control form-control-sm" value="@p.Observaciones" @onchange="(e => CambiarObs(p, e))" />
                                }
                                else
                                {
                                    <span>@p.Observaciones</span>
                                }
                            </td>
                            <td class="text-end">
                                @if (enEdicion)
                                {
                                    <button class="btn btn-sm btn-success me-1" @onclick="(() => GuardarEdicion(p))"><i class="bi bi-check-lg"></i> Guardar</button>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="CancelarEdicion"><i class="bi bi-x-lg"></i> Cancelar</button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="(() => Editar(p))"><i class="bi bi-pencil-square"></i> Editar</button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="(() => Eliminar(p))"><i class="bi bi-trash"></i> Eliminar</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            No hay procedimientos añadidos.
        </div>
    }

    <button class="btn btn-primary mt-3 w-100" @onclick="AgregarSeleccionado" disabled="@(_seleccionActual == null)">
        <i class="bi bi-plus-circle me-2"></i> Agregar Procedimiento
    </button>
</div>

@code {
    [Inject] public IProcedimientoService ProcedimientoService { get; set; } = default!;

    // Lista que maneja este componente
    [Parameter] public List<ProcSelVM> Procedimientos { get; set; } = new();
    [Parameter] public EventCallback<List<ProcSelVM>> ProcedimientosChanged { get; set; }

    // Eventos para notificar al padre (opcional)
    [Parameter] public EventCallback<ProcSelVM> OnAgregar { get; set; }
    [Parameter] public EventCallback<ProcSelVM> OnEliminar { get; set; }
    [Parameter] public EventCallback<ProcSelVM> OnEditar { get; set; }

    private string _textoBusqueda = string.Empty;
    private List<ProcedimientoDto> _sugerencias = new();
    private ProcedimientoDto? _seleccionActual;

    private int? _editandoId = null;
    private int _backupOrden;
    private string? _backupObs;

    private CancellationTokenSource? _cts;

    private async Task OnTextoChanged(ChangeEventArgs e)
    {
        _textoBusqueda = e.Value?.ToString() ?? string.Empty;
        _seleccionActual = null; // limpiar selección si cambia el texto

        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        var token = _cts.Token;

        if (string.IsNullOrWhiteSpace(_textoBusqueda) || _textoBusqueda.Length < 2)
        {
            _sugerencias = new();
            return;
        }

        try
        {
            await Task.Delay(300, token); // debounce
            if (token.IsCancellationRequested) return;
            _sugerencias = await ProcedimientoService.BuscarProcedimientosAsync(_textoBusqueda);
        }
        catch (TaskCanceledException) { }
        catch { _sugerencias = new(); }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            if (_seleccionActual == null && _sugerencias.Count > 0)
            {
                SeleccionarSugerencia(_sugerencias[0]);
            }
            await AgregarSeleccionado();
        }
    }

    private async Task Buscar()
    {
        if (string.IsNullOrWhiteSpace(_textoBusqueda))
        {
            _sugerencias = new();
            _seleccionActual = null;
            return;
        }
        _sugerencias = await ProcedimientoService.BuscarProcedimientosAsync(_textoBusqueda);
    }

    private void SeleccionarSugerencia(ProcedimientoDto dto)
    {
        _seleccionActual = dto;
        _textoBusqueda = $"{dto.Codigo} - {dto.Nombre}";
        _sugerencias = new();
    }

    private async Task AgregarSeleccionado()
    {
        if (_seleccionActual == null) return;
        if (Procedimientos.Any(x => x.ProcedimientoId == _seleccionActual.Id)) return; // evitar duplicados

        var nuevo = new ProcSelVM
        {
            ProcedimientoId = _seleccionActual.Id,
            Codigo = _seleccionActual.Codigo,
            Nombre = _seleccionActual.Nombre,
            EsPrincipal = false,
            Orden = Procedimientos.Count + 1,
            Observaciones = string.Empty
        };
        Procedimientos.Add(nuevo);
        await ProcedimientosChanged.InvokeAsync(Procedimientos);
        await OnAgregar.InvokeAsync(nuevo);

        _seleccionActual = null;
        _textoBusqueda = string.Empty;
        _sugerencias = new();
    }

    private async Task Eliminar(ProcSelVM vm)
    {
        Procedimientos.Remove(vm);
        await ProcedimientosChanged.InvokeAsync(Procedimientos);
        await OnEliminar.InvokeAsync(vm);
    }

    private void Editar(ProcSelVM vm)
    {
        _editandoId = vm.ProcedimientoId;
        _backupOrden = vm.Orden;
        _backupObs = vm.Observaciones;
    }

    private async Task GuardarEdicion(ProcSelVM vm)
    {
        _editandoId = null;
        await ProcedimientosChanged.InvokeAsync(Procedimientos);
        await OnEditar.InvokeAsync(vm);
    }

    private void CancelarEdicion()
    {
        if (_editandoId.HasValue)
        {
            var vm = Procedimientos.FirstOrDefault(x => x.ProcedimientoId == _editandoId.Value);
            if (vm != null)
            {
                vm.Orden = _backupOrden;
                vm.Observaciones = _backupObs;
            }
        }
        _editandoId = null;
    }

    private async Task CambiarOrden(ProcSelVM vm, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var val))
        {
            vm.Orden = Math.Max(1, val);
            await ProcedimientosChanged.InvokeAsync(Procedimientos);
            await OnEditar.InvokeAsync(vm);
        }
    }

    private async Task CambiarObs(ProcSelVM vm, ChangeEventArgs e)
    {
        vm.Observaciones = e.Value?.ToString();
        await ProcedimientosChanged.InvokeAsync(Procedimientos);
        await OnEditar.InvokeAsync(vm);
    }
}