@page "/generar_solicitud_medico"
@layout Components.Layout.MainLayoutMedico



@using proyecto_hospital_version_1.Data._Legacy
@using proyecto_hospital_version_1.Services
@using proyecto_hospital_version_1.Components.Shared
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using Hospital.Api.Data.DTOs

@using ApiEntities = Hospital.Api.Data.Entities;


@inject HospitalDbContextLegacy HospitalDb
@inject IProcedimientoService ProcedimientoService
@inject ISolicitudQuirurgicaApiService SolicitudApiService
@inject IConsentimientoInformadoService ConsentimientoService
@inject IJSRuntime JsRuntime // Para posibles alertas o interacciones JS
@inject HttpClient Http // para http


<PageTitle>Nueva Solicitud Quirúrgica</PageTitle>





<div class="solicitud-container">
    <div class="row">
        <!-- Columna Izquierda Principal (Contiene todo el flujo) , se pondr arroba usinf-->
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Nueva Solicitud Quirúrgica</h1>

            @if (_pasoActual == 1)
            {
                <Paso1ContextoCard @bind-PacienteSeleccionado="_pacienteSeleccionado"
                                   @bind-ProcedenciaSeleccionada="_procedenciaSeleccionada"
                                   @bind-ProcedimientoSeleccionado="_procedimientoSeleccionado"
                                   @bind-LateralidadSeleccionada="_lateralidadSeleccionada"
                                   @bind-ExtremidadSeleccionada="_extremidadSeleccionada"
                                   @bind-ConsentimientoAceptado="_consentimientoAceptado"
                                   ListaProcedimientos="_listaProcedimientos" />
            }

            @if (_pasoActual == 2)
            {
                <Paso2RequerimientosCard Paciente="_pacienteSeleccionado"
                                         DiagnosticoPrincipal="@_diagnosticoPrincipal"
                                         DiagnosticoPrincipalChanged="(value) => _diagnosticoPrincipal = value"
                                         EsGes="_esGes"
                                         EsGesChanged="(value) => _esGes = value"
                                         CodigoAsociado="@_codigoAsociado"
                                         CodigoAsociadoChanged="(value) => _codigoAsociado = value"
                                         Peso="_peso"
                                         PesoChanged="(value) => _peso = value"
                                         Talla="_talla"
                                         TallaChanged="(value) => _talla = value"
                                         IMC="_imc"
                                         EspecialidadOrigen="_especialidadOrigen"
                                         EspecialidadOrigenChanged="(value) => _especialidadOrigen = value"
                                         EspecialidadDestino="_especialidadDestino"
                                         EspecialidadDestinoChanged="(value) => _especialidadDestino = value" />
            }

            @if (_pasoActual == 3)
            {
                                  
                    <Paso3GenerarSolicitudCard Paciente="_pacienteSeleccionado"
                                           ProcedimientoPrincipal="@_procedimientoSeleccionado"
                                           DiagnosticoPrincipal="@_diagnosticoPrincipal"
                                           ProcedenciaPrincipal="@_procedenciaSeleccionada"
                                           EsGes="@_esGes"
                                           @bind-EquiposSeleccionados="_equiposSeleccionados"
                                           @bind-TipoMesaSeleccionado="_tipoMesaSeleccionado"
                                           @bind-EvaluacionAnestesica="_evaluacionAnestesica"
                                           @bind-Transfusiones="_transfusiones"
                                           @bind-SalaOperaciones="_salaOperaciones"
                                           @bind-TiempoEstimado="_tiempoEstimado"
                                           @bind-ComorbilidadesSeleccionadas="_comorbilidadesSeleccionadas"
                                           @bind-ComentariosAdicionales="_comentariosAdicionales" />
            }
            @*
                 Botones de Navegación 
                <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-secondary me-2" @onclick="GoPreviousStep" disabled="@(_pasoActual == 1)">← Anterior</button>
                <button class="btn btn-primary" @onclick="GoNextStep" disabled="@(_pasoActual == 3)">Siguiente →</button>
            </div>


            *@
            <!-- Botones de Navegación -->
            <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-secondary me-2" @onclick="GoPreviousStep" disabled="@(_pasoActual == 1)">← Anterior</button>
    
                @if (_pasoActual == 3)
                {
                    <button class="btn btn-success" @onclick="GuardarSolicitud">
                        <i class="bi bi-check-circle me-2"></i> Guardar Solicitud
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="GoNextStep">Siguiente →</button>
                }
            </div>
        </div>

        <!-- Columna Derecha (Alertas) - No se modifica -->
        <div class="col-lg-4">
            <div class="card alert-widget-sticky">
                <div class="card-body">
                    <h5 class="card-title mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i> Alertas Clínicas Clave</h5>
                    <p class="alert-item alergia">❗ Alergia a Penicilina</p>
                    
                </div>
            </div>
        </div>
    </div>

    @* Codigo para comprobar *@

    <!-- PANEL DE VERIFICACIÓN VISUAL -->
    




































</div>



<style>
    .alert-widget-sticky {
        position: sticky;
        top: 20px;
    }

    .info-paciente {
        font-size: 0.95rem;
    }

    .solicitud-container {
        padding: 20px;
    }
</style>

@code {
    // Variables existentes
    private proyecto_hospital_version_1.Data._Legacy.PacienteHospital? _pacienteSeleccionado = null;
    private string _procedenciaSeleccionada = "Ambulatorio"; 
    private int? NumeroBusqueda { get; set; }
    private string TextoBusqueda { get; set; } = string.Empty;





    private string _procedimientoSeleccionado = "";
    private string _lateralidadSeleccionada = "";
    private string _extremidadSeleccionada = "";

    // Variables para búsqueda de pacientes
    private List<PacienteHospital> _pacientes = new();
    private string _estado = "inicial";
    private string? _error;
    private int _cantidadMostrar = 10;
    private int _totalPacientes = 0;
    private string _busquedaTexto = "";
    private string _busquedaDv = "";


    private string _nombrePacienteParaMostrar = "";
    private string _rutPacienteParaMostrar = "";



    // variables fase 1 

    private List<ProcedimientoDto> _listaProcedimientos = new();

    
    // variables para cambiar de rutas

    private int _pasoActual = 1;
    private bool _consentimientoAceptado = false;


    // variables de la 2nda etapa


    private string _diagnosticoPrincipal = "";
    private bool _esGes = false;


    // variables para la generación del consentimiento informado pdf
    private bool _isPaso3Ready; // Nueva variable para el estado del Paso 3


    // --- VARIABLES FALTANTES DE PASO 2 ---
    private string _codigoAsociado = ""; // 
    private decimal? _peso;
    private decimal? _talla; // ahora se guardara en cm
    // Correcion de fomrmula para que acepte cm en vez de metros
    private decimal? _imc


    // variables para el id del consentimiento de la api

    





    {
        get
        {
            if (!_peso.HasValue || !_talla.HasValue || _talla <= 0 || _peso <= 0)
                return null;

            decimal alturaMetros = _talla.Value / 100;
            return Math.Round(_peso.Value / (alturaMetros * alturaMetros), 2);
        }
    }
    private string _especialidadOrigen = "";
    private string _especialidadDestino = "";

    // --- VARIABLES FALTANTES DE PASO 3 ---
    private List<string> _equiposSeleccionados = new List<string>();
    private string _tipoMesaSeleccionado = "Estándar General";
    private bool _evaluacionAnestesica;
    private bool _transfusiones;
    private string _salaOperaciones = "";
    private int? _tiempoEstimado;
    private List<string> _comorbilidadesSeleccionadas = new List<string>();
    private string _comentariosAdicionales = "";



    // --- NUEVAS VARIABLES PARA LA API ---
    private int _consentimientoInformadoApiId = 0;
    private int _solicitudQuirurgicaApiId = 0;

    // Diccionarios para Lateralidad y Extremidad
    private Dictionary<string, int> _lateralidades = new()
    {
        {"Derecha", 1},
        {"Izquierda", 2},
        {"No Aplica", 3}
    };

    private Dictionary<string, int> _extremidades = new()
    {
        {"Superior", 1},
        {"Inferior", 2},
        {"No Aplica", 3}
    };




    private bool _mostrarPDF = false;
    private ConsentimientoPDF? _consentimientoPdfRef; // 

    private bool PuedeGenerarPDF =>
        _pacienteSeleccionado != null &&
        _consentimientoAceptado &&
        !string.IsNullOrEmpty(_procedimientoSeleccionado);

    public async Task GenerarPDF()
    {
        Console.WriteLine($"[Generar_Solicitud_Medico] Botón Generar PDF clickeado.");
        Console.WriteLine($"[Generar_Solicitud_Medico] _pacienteSeleccionado es null? {_pacienteSeleccionado == null}");
        Console.WriteLine($"[Generar_Solicitud_Medico] _procedimientoSeleccionado: {_procedimientoSeleccionado}");
        Console.WriteLine($"[Generar_Solicitud_Medico] _consentimientoAceptado: {_consentimientoAceptado}");
        Console.WriteLine($"[Generar_Solicitud_Medico] PuedeGenerarPDF: {PuedeGenerarPDF}");


        // Se llama a ActualizarDatosPDF para que Blazor re-evalúe los parámetros del componente hijo.
        // Esto es crucial para que el componente ConsentimientoPDF vea los datos actualizados.
        if (_consentimientoPdfRef != null)
        {
            // Forzar la re-asignación de los parámetros para asegurar que Blazor los actualice.
            // Aunque se hace vía binding, a veces es útil forzar la referencia.
            // (La línea original en tu código ya hacía esto: _consentimientoPdfRef.Paciente = _pacienteSeleccionado;)
            // Aquí no necesitamos re-asignarlos manualmente porque ya están como Parameters.
            // El `StateHasChanged()` de este componente padre, o la llamada al método hijo,
            // debería provocar la actualización de los parámetros del hijo.
        }
        else
        {
            Console.Error.WriteLine("[Generar_Solicitud_Medico] ERROR: _consentimientoPdfRef es NULL. El componente ConsentimientoPDF no se ha renderizado o asignado correctamente.");
            await JsRuntime.InvokeVoidAsync("alert", "Error interno: El componente de generación de PDF no está disponible. Contacte a soporte.");
            return;
        }

        if (PuedeGenerarPDF)
        {
            Console.WriteLine("[Generar_Solicitud_Medico] Llamando a _consentimientoPdfRef.GenerarPdf()...");
            await _consentimientoPdfRef.GenerarPdf();
        }
        else
        {
            Console.WriteLine("[Generar_Solicitud_Medico] No se cumplen las condiciones para generar el PDF.");
            string mensaje = "No se puede generar el PDF. Asegúrese de:\n" +
                             "1. Haber seleccionado un paciente.\n" +
                             "2. Haber seleccionado un procedimiento principal.\n" +
                             "3. Haber marcado la casilla de consentimiento.";
            await JsRuntime.InvokeVoidAsync("alert", mensaje);
        }
    }





    private async Task CargarPacientes()
    {
        if (string.IsNullOrWhiteSpace(_busquedaTexto) && string.IsNullOrWhiteSpace(_busquedaDv))
        {
            return;
        }
        _estado = "cargando";
        StateHasChanged();

        try
        {
            var query = HospitalDb.Pacientes
            .Include(p => p.Ubicaciones)  // 
        .    AsQueryable();
            if (!string.IsNullOrWhiteSpace(_busquedaTexto))
            {
                var busqueda = _busquedaTexto.ToLower();
                query = query.Where(p =>
                    p.primerNombre.ToLower().Contains(busqueda) ||
                    (p.segundoNombre != null && p.segundoNombre.ToLower().Contains(busqueda)) ||
                    p.apellidoPaterno.ToLower().Contains(busqueda) ||
                    (p.apellidoMaterno != null && p.apellidoMaterno.ToLower().Contains(busqueda)) ||
                    p.rut.Contains(busqueda)
                );
            }

            if (!string.IsNullOrWhiteSpace(_busquedaDv))
            {
                var dvUpper = _busquedaDv.ToUpper();
                query = query.Where(p => p.dv.ToUpper() == dvUpper);
            }


            var pacienteEncontrado = await query.FirstOrDefaultAsync();

            if (pacienteEncontrado != null)
            {
                _pacienteSeleccionado = pacienteEncontrado;

                _nombrePacienteParaMostrar = $"{pacienteEncontrado.primerNombre} {pacienteEncontrado.apellidoPaterno}";
                _rutPacienteParaMostrar = $"{pacienteEncontrado.rut}-{pacienteEncontrado.dv}";
            }
            else
            {
                // Si no se encuentra, mostramos un mensaje indicándolo.
                _pacienteSeleccionado = null;
                _nombrePacienteParaMostrar = "Paciente no encontrado";
                _rutPacienteParaMostrar = "";
            }
            // ===== FIN DEL CAMBIO IMPORTANTE =====

            _estado = "ok";
        }
        catch (Exception ex)
        {
            _estado = "error";
            _error = ex.Message;
            Console.WriteLine($"Error al buscar pacientes: {ex}");
        }

        StateHasChanged();
    }

    private async Task BuscarPacientes()
    {
        await CargarPacientes();
    }

    private async Task LimpiarBusqueda()
    {
        _busquedaTexto = "";
        _busquedaDv = "";
        _pacientes.Clear();
        _estado = "inicial";
        _pacienteSeleccionado = null;

        _nombrePacienteParaMostrar = "";
        _rutPacienteParaMostrar = "";


        StateHasChanged();
    }

    private void SeleccionarPaciente(PacienteHospital paciente)
    {
        Console.WriteLine($"Paciente seleccionado: {paciente.primerNombre} {paciente.apellidoPaterno}");
    }

    private void Buscar()
    {
        Console.WriteLine($"Número ingresado: {NumeroBusqueda}");
        Console.WriteLine($"Texto ingresado: {TextoBusqueda}");
    }


    private async Task GuardarSolicitud()
    {
        if (_pasoActual != 3) return;

        // VALIDACIONES MANUALES
        var errores = new List<string>();

        if (_pacienteSeleccionado == null)
            errores.Add("• Paciente no seleccionado");

        if (string.IsNullOrWhiteSpace(_diagnosticoPrincipal))
            errores.Add("• Diagnóstico principal vacío");

        if (string.IsNullOrWhiteSpace(_salaOperaciones))
            errores.Add("• Sala de operaciones no especificada");

        if (!_tiempoEstimado.HasValue || _tiempoEstimado <= 0)
            errores.Add("• Tiempo estimado no válido (debe ser mayor a 0)");

        if (_equiposSeleccionados.Count == 0)
            errores.Add("• No se han seleccionado equipos requeridos");

        // Validaciones para peso y talla
        if (!_peso.HasValue || _peso <= 0)
            errores.Add("• Peso no válido");

        if (!_talla.HasValue || _talla <= 0)
            errores.Add("• Talla no válida");

        // ✅ VALIDACIÓN CRÍTICA NUEVA - Consentimiento
        if (_consentimientoInformadoApiId == 0)
            errores.Add("• No se ha generado el consentimiento informado. Complete el Paso 1 correctamente.");

        if (errores.Any())
        {
            var mensajeError = "Faltan los siguientes datos esenciales:\n" + string.Join("\n", errores);
            await JsRuntime.InvokeVoidAsync("alert", mensajeError);
            return;
        }

        try
        {
            Console.WriteLine("🔍 === ENVIANDO SOLICITUD A API ===");
            Console.WriteLine($"   - ConsentimientoId: {_consentimientoInformadoApiId}");
            Console.WriteLine($"   - PacienteId: {_pacienteSeleccionado.id}");

            // ✅ CREAR DTO CORRECTO para la nueva API
            var solicitudDto = new SolicitudCrearDto
            {
                // ✅ CAMPOS CRÍTICOS para FKs
                ConsentimientoId = _consentimientoInformadoApiId,
                PacienteId = _pacienteSeleccionado.id,
                DiagnosticoPrincipal = _diagnosticoPrincipal,
                Procedencia = _procedenciaSeleccionada,
                EspecialidadDestino = string.IsNullOrWhiteSpace(_especialidadDestino)
                ? "Cirugía Urgencia" // 
                : _especialidadDestino, // Valor por defecto

                // ✅ CAMPOS CLÍNICOS
                Peso = _peso.Value,
                Talla = _talla.Value,
                IMC = _imc ?? 0,
                TiempoEstimado = _tiempoEstimado.Value,

                // ✅ CAMPOS DE EVALUACIÓN
                EvaluacionAnestesica = _evaluacionAnestesica,
                EvaluacionTransfusion = _transfusiones,
                EsGes = _esGes,

                // ✅ CAMPOS ADICIONALES
                Comentarios = _comentariosAdicionales,
                EspecialidadOrigen = _especialidadOrigen,

                // ❌ CAMPOS QUE NO SE USAN (pero se envían por compatibilidad)
                ProcedimientoPrincipal = _procedimientoSeleccionado, // No se usa en el service
                Lateralidad = _lateralidadSeleccionada, // No se usa en el service
                Extremidad = _extremidadSeleccionada // No se usa en el service
            };

            Console.WriteLine("📦 DTO creado para enviar a API:");
            Console.WriteLine($"   - ConsentimientoId: {solicitudDto.ConsentimientoId}");
            Console.WriteLine($"   - DiagnosticoPrincipal: {solicitudDto.DiagnosticoPrincipal}");
            Console.WriteLine($"   - EspecialidadDestino: {solicitudDto.EspecialidadDestino}");

            // ✅ ENVIAR A LA NUEVA API
            var exito = await SolicitudApiService.CrearSolicitudAsync(solicitudDto);

            if (exito)
            {
                Console.WriteLine("✅ Solicitud guardada exitosamente");
                await JsRuntime.InvokeVoidAsync("alert", "✅ Solicitud guardada correctamente en la base real.");
                ResetFormulario();
                _pasoActual = 1;
                StateHasChanged();
            }
            else
            {
                Console.WriteLine("❌ Falló CrearSolicitudAsync");
                await JsRuntime.InvokeVoidAsync("alert", "❌ Error al enviar la solicitud a la API.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"💥 EXCEPCIÓN en GuardarSolicitud: {ex.Message}");
            Console.WriteLine($"💥 StackTrace: {ex.StackTrace}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error al enviar a API: {ex.Message}");
        }
    }

    private void ResetFormulario()
    {
        // Resetea todas las variables a su estado inicial
        _pacienteSeleccionado = null;
        _busquedaTexto = "";
        _busquedaDv = "";
        _nombrePacienteParaMostrar = "";
        _rutPacienteParaMostrar = "";

        _procedenciaSeleccionada = "Ambulatorio";
        _procedimientoSeleccionado = "";
        _lateralidadSeleccionada = "";
        _extremidadSeleccionada = "";
        _consentimientoAceptado = false;

        _diagnosticoPrincipal = "";
        _esGes = false;
        _codigoAsociado = "";
        _peso = null;
        _talla = null;
        _especialidadOrigen = "";
        _especialidadDestino = "";

        _equiposSeleccionados = new List<string>();
        _tipoMesaSeleccionado = "Estándar General"; // Asegúrate de que este valor coincida con el default en Paso3
        _evaluacionAnestesica = false;
        _transfusiones = false;
        _salaOperaciones = "";
        _tiempoEstimado = null;
        _comorbilidadesSeleccionadas = new List<string>();
        _comentariosAdicionales = "";

        _isPaso3Ready = false; // Resetear el estado del paso 3
    }

    // Método para verificar si un paso está listo para avanzar
    private bool IsPasoReady(int paso)
    {
        switch (paso)
        {
            case 1:
                return _pacienteSeleccionado != null &&
                       !string.IsNullOrEmpty(_procedimientoSeleccionado) &&
                       _consentimientoAceptado;
            case 2:
                return !string.IsNullOrEmpty(_diagnosticoPrincipal) &&
                       !string.IsNullOrEmpty(_codigoAsociado) && // Si CIE-10 es obligatorio
                       _peso.HasValue && _talla.HasValue && _peso > 0 && _talla > 0;
            case 3:
                return _isPaso3Ready; // Depende de la validación interna del componente Paso3GenerarSolicitudCard
            default:
                return false;
        }
    }










    private async Task GoNextStep() // Es importante que sea async para poder usar await
{
    // === PASO 1 ===
    if (_pasoActual == 1)
    {
        // Validaciones del Paso 1
        if (_pacienteSeleccionado == null)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe seleccionar un paciente para continuar.");
            return;
        }
        if (string.IsNullOrEmpty(_procedimientoSeleccionado))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe seleccionar un Procedimiento Principal.");
            return;
        }
        if (!_consentimientoAceptado)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe aceptar el consentimiento informado para continuar.");
            return;
        }
        if (string.IsNullOrWhiteSpace(_lateralidadSeleccionada) || !_lateralidades.ContainsKey(_lateralidadSeleccionada))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe seleccionar una Lateralidad válida.");
            return;
        }
        if (string.IsNullOrWhiteSpace(_extremidadSeleccionada) || !_extremidades.ContainsKey(_extremidadSeleccionada))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe seleccionar una Extremidad válida.");
            return;
        }

        // --- LÓGICA DE ESCRITURA DUAL: Crear ConsentimientoInformadoReal en la API ---
        // Esto ocurre justo ANTES de pasar al Paso 2, una vez que el Paso 1 está validado.

        // 🔍 DEBUG CRÍTICO - ANTES DE ENVIAR A LA API
        Console.WriteLine("🔍 === DEBUG CRÍTICO - VERIFICACIÓN DE IDs ===");

        // 1. Verificar diccionarios
        Console.WriteLine($"📚 DICCIONARIOS ACTUALES:");
        Console.WriteLine($"   - Lateralidades: {string.Join(", ", _lateralidades.Select(kv => $"{kv.Key}={kv.Value}"))}");
        Console.WriteLine($"   - Extremidades: {string.Join(", ", _extremidades.Select(kv => $"{kv.Key}={kv.Value}"))}");

        // 2. Verificar selecciones actuales
        Console.WriteLine($"🎯 SELECCIONES ACTUALES:");
        Console.WriteLine($"   - Lateralidad seleccionada: '{_lateralidadSeleccionada}'");
        Console.WriteLine($"   - Extremidad seleccionada: '{_extremidadSeleccionada}'");

        // 3. Obtener IDs
        var lateralidadApiId = _lateralidades[_lateralidadSeleccionada];
        var extremidadApiId = _extremidades[_extremidadSeleccionada];

        Console.WriteLine($"🔢 IDs CALCULADOS:");
        Console.WriteLine($"   - LateralidadId: {lateralidadApiId}");
        Console.WriteLine($"   - ExtremidadId: {extremidadApiId}");
        // Obtener el ID del procedimiento. Asumimos que ProcedimientoDto.Id es el que necesita la API.
        var procedimientoApiId = _listaProcedimientos.FirstOrDefault(p => p.Nombre == _procedimientoSeleccionado)?.Id ?? 0;

        if (procedimientoApiId == 0)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Error: No se pudo encontrar el ID del Procedimiento Principal seleccionado para la API. Contacte a soporte.");
            return;
        }

        // Crear el objeto ConsentimientoInformadoReal para la API
        var nuevoConsentimientoApi = new ApiEntities.ConsentimientoInformadoReal
        {
            FechaGeneracion = DateTime.Now,
            Estado = true, // O el estado inicial que desees
            Observacion = _comentariosAdicionales, // Si tienes algún comentario relacionado con el consentimiento
            PacienteId = _pacienteSeleccionado.id, // ¡Importante! Asegúrate que es '.id' o '.Id' según tu PacienteHospital legacy
            ProcedimientoId = procedimientoApiId,
            LateralidadId = lateralidadApiId,
            ExtremidadId = extremidadApiId,
        };

        try
        {
            // Llama al servicio para crear el consentimiento en la API
            _consentimientoInformadoApiId = await ConsentimientoService.CrearConsentimientoAsync(nuevoConsentimientoApi);

            if (_consentimientoInformadoApiId == 0)
            {
                await JsRuntime.InvokeVoidAsync("alert", "Error al generar el Consentimiento Informado en la API. No se pudo obtener un ID. No se puede continuar.");
                return;
            }
            else
            {
                Console.WriteLine($"Consentimiento Informado API creado con ID: {_consentimientoInformadoApiId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR al crear Consentimiento API: {ex.Message}. Inner: {ex.InnerException?.Message}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error al crear Consentimiento en la API: {ex.Message}. Detalles: {ex.InnerException?.Message}");
            return; // No avanzar si falla la creación del consentimiento en la API
        }
    } // Fin del if (_pasoActual == 1)

    // === PASO 2 ===
    if (_pasoActual == 2)
    {
        // Validaciones del Paso 2
        if (string.IsNullOrEmpty(_diagnosticoPrincipal))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe ingresar un diagnóstico principal en el Paso 2.");
            return;
        }
        // Puedes agregar más validaciones para Peso, Talla, etc. aquí si lo deseas antes de avanzar
        if (!_peso.HasValue || _peso <= 0)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe ingresar un Peso válido en el Paso 2.");
            return;
        }
        if (!_talla.HasValue || _talla <= 0)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Debe ingresar una Talla válida en el Paso 2.");
            return;
        }
    } // Fin del if (_pasoActual == 2)


    // === LÓGICA PARA AVANZAR AL SIGUIENTE PASO ===
    // Solo avanza si no hay problemas y no estamos ya en el último paso (Paso 3)
    if (_pasoActual < 3)
    {
        _pasoActual++;
        StateHasChanged(); // Forzar el renderizado del componente
    }
    // Si estamos en el paso 3 y se intenta "avanzar" (lo cual no debería ocurrir con el botón "Siguiente"),
    // la acción de guardar la solicitud se maneja por el botón "Guardar Solicitud".
}





    private void GoPreviousStep()
    {
        if (_pasoActual > 1)
        {
            _pasoActual--;
            StateHasChanged();
        }
    }




    private async Task ActualizarDatosPDF()
    {
        if (_consentimientoPdfRef != null)
        {
            // Forzar la actualización de los parámetros
            _consentimientoPdfRef.Paciente = _pacienteSeleccionado;
            _consentimientoPdfRef.Procedimiento = _procedimientoSeleccionado;
            _consentimientoPdfRef.Lateralidad = _lateralidadSeleccionada;
            _consentimientoPdfRef.Extremidad = _extremidadSeleccionada;

            // Forzar re-renderizado del componente
            StateHasChanged();
        }
    }

    // para agregar cosas asincronas
    protected override async Task OnInitializedAsync()
    {


        // Cargar los procedimientos desde la base de datos
        await CargarListaProcedimientos();

        // Ejemplo: await CargarOtraCosaAsync();
    }

    private async Task CargarListaProcedimientos()
    {
        try
        {
            // Llama a la API mediante el servicio
            _listaProcedimientos = await ProcedimientoService.GetProcedimientosAsync();

            Console.WriteLine($"Procedimientos cargados: {_listaProcedimientos.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar procedimientos desde API: {ex.Message}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error al cargar procedimientos: {ex.Message}");
        }
    }








}