@page "/mis-solicitudes-medico"
@layout Components.Layout.MainLayoutMedico
@using MudBlazor
@inject ISolicitudQuirurgicaApiService SolicitudApiService

<PageTitle>Mis Solicitudes - Médico</PageTitle>

<div class="container-fluid mt-4">

    <!-- Título -->
    <div class="row">
        <div class="col-12">
            <h2 class="fw-bold mb-1">Mis Solicitudes</h2>
            <p class="text-muted mb-4">Resumen rápido del estado de tus solicitudes y próximas fechas.</p>
        </div>
    </div>

    <!-- 1) KPI CARDS -->
    <div class="row g-3 kpi-row">
        <div class="col-12 col-md-4">
            <div class="kpi-card">
                <div class="kpi-label">Total del Médico</div>
                <div class="kpi-value">@KpiTotal</div>
                <div class="kpi-foot"><i class="bi bi-person-badge"></i> Dr. Gabriel Picand</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="kpi-card kpi-warn">
                <div class="kpi-label">Pendientes</div>
                <div class="kpi-value">@KpiPendientes</div>
                <div class="kpi-foot"><i class="bi bi-hourglass-split"></i> En espera de priorización</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="kpi-card kpi-ok">
                <div class="kpi-label">Priorizadas</div>
                <div class="kpi-value">@KpiPriorizadas</div>
                <div class="kpi-foot"><i class="bi bi-check2-circle"></i> Últimas 2 semanas</div>
            </div>
        </div>
    </div>

    <!-- 2) BLOQUES PARALELOS: Priorizadas (izquierda) / Programadas (derecha) -->
    <div class="row g-4 mt-1">
        <!-- IZQ: Solicitudes Priorizadas -->
        <div class="col-12 col-lg-7">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <MudIcon Icon="@Icons.Material.Filled.Checklist" Class="me-2 text-success" />
                        <h5 class="mb-0">Solicitudes Priorizadas</h5>
                    </div>
                    <span class="badge bg-success">Total: @Priorizadas.Count</span>
                </div>
                <div class="card-body p-0">
                    @if (Priorizadas.Count == 0)
                    {
                        <div class="p-3 text-muted">No hay solicitudes priorizadas.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="thead-hospital-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Paciente</th>
                                        <th>Dx / Proc.</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var s in Priorizadas)
                                    {
                                        <tr>
                                            <td class="fw-semibold">@s.Id</td>
                                            <td>
                                                <div class="fw-semibold">@s.NombrePaciente</div>
                                                <small class="text-muted">RUT @s.Rut</small>
                                            </td>
                                            <td>
                                                <div>@s.Procedimiento</div>
                                                <small class="text-muted">@s.Diagnostico</small>
                                            </td>
                                            <td class="text-end">
                                                <a class="btn btn-sm btn-outline-primary" href="/priorizar-solicitudes/@s.Id">
                                                    Ver / Editar
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- DER: Solicitudes Programadas (con barra de progreso UN COLOR) -->
        <div class="col-12 col-lg-5">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <MudIcon Icon="@Icons.Material.Filled.Event" Class="me-2 text-primary" />
                        <h5 class="mb-0">Solicitudes Programadas</h5>
                    </div>
                    <span class="badge bg-primary">Total: @Programadas.Count</span>
                </div>

                <div class="list-group list-group-flush">
                    @if (Programadas.Count == 0)
                    {
                        <div class="p-3 text-muted">Sin fechas programadas.</div>
                    }
                    else
                    {
                        @foreach (var p in Programadas)
                        {
                            var pct = GetSlaPctProgramada(p);      // 0-100
                            var dias = p.DiasRestantes ?? 0;

                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-semibold">#@p.Id — @p.NombrePaciente</div>
                                        <small class="text-muted d-block">Fecha: @p.FechaProgramada?.ToString("dd/MM/yyyy")</small>
                                    </div>
                                    <span class="badge bg-secondary">Días: @dias</span>
                                </div>

                                <!-- Barra de progreso: un solo color -->
                                <div class="progress progress-sla mt-2" title="Progreso hacia la cirugía">
                                    <div class="progress-bar bg-primary" style="width:@pct%">
                                        @pct%
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

</div>

<style>
    .kpi-row .kpi-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: .75rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 6px 18px rgba(0,0,0,.06)
    }

    .kpi-label {
        font-size: .9rem;
        color: #6c757d;
    }

    .kpi-value {
        font-size: 1.8rem;
        font-weight: 800;
        line-height: 1;
        margin: .25rem 0 .35rem;
    }

    .kpi-foot {
        font-size: .8rem;
        color: #6c757d;
    }

    .kpi-warn .kpi-value {
        color: #d39e00;
    }

    .kpi-ok .kpi-value {
        color: #198754;
    }

    .thead-hospital-light {
        background-color: #e9f2ff;
        border-bottom: 2px solid #0d6efd;
        color: #052c65;
        font-weight: 600;
    }

    .table-hover tbody tr:hover {
        background: #f8fbff;
    }

    .progress-sla {
        height: 14px;
        background: #eef2f6;
    }

        .progress-sla .progress-bar {
            font-size: .70rem;
            font-weight: 700;
        }

    .sla-ok {
        background: #198754;
    }

    .sla-warn {
        background: #ffc107;
        color: #212529;
    }

    .sla-bad {
        background: #dc3545;
    }
</style>

@code {
    // ===== ViewModel mínimo para la tabla =====
    public class SolicitudResumenVM
    {
        public int Id { get; set; }
        public string NombrePaciente { get; set; } = "";
        public string Rut { get; set; } = "";
        public string Diagnostico { get; set; } = "";
        public string Procedimiento { get; set; } = "";
        public string Estado { get; set; } = "Pendiente";
        public DateTime FechaCreacion { get; set; } = DateTime.Now.AddDays(-10);

        // Dummies:
        public DateTime? FechaProgramada { get; set; }   // fecha target
        public int? DiasRestantes { get; set; }          // FechaProgramada - Hoy
        public string Contactabilidad { get; set; } = "Por Contactar"; // Contactado | Sin Respuesta | Por Contactar
    }

    // ===== Datos de demo (ahora cargados desde API) =====
    private List<SolicitudResumenVM> Resumen = new();

    // Particiones para las 2 vistas
    private List<SolicitudResumenVM> Priorizadas = new();
    private List<SolicitudResumenVM> Programadas = new();

    // KPIs
    private int KpiTotal => Resumen.Count;
    private int KpiPendientes => Resumen.Count(s => !s.Estado.Contains("Priorizada"));
    private int KpiPriorizadas => Resumen.Count(s => s.Estado.Contains("Priorizada"));

    protected override async Task OnInitializedAsync()
    {
        // ✅ CAMBIO CRÍTICO: Ahora carga desde la API
        await CargarSolicitudesDesdeApi();

        // Particionar los datos
        Priorizadas = Resumen.Where(s => s.Estado.Contains("Priorizada")).ToList();
        Programadas = Resumen.Where(s => s.FechaProgramada.HasValue).OrderBy(s => s.FechaProgramada).ToList();
    }

    // ✅ NUEVO: Cargar solicitudes desde la API
    private async Task CargarSolicitudesDesdeApi()
    {
        try
        {
            // TODO: Reemplaza '1' con el ID real del médico autenticado
            var idMedico = 1;

            var solicitudesApi = await SolicitudApiService.ObtenerSolicitudesPorMedicoAsync(idMedico);

            Resumen = solicitudesApi.Select(s => new SolicitudResumenVM
            {
                Id = s.Id,
                NombrePaciente = s.NombrePaciente,
                Rut = s.Rut,
                Diagnostico = s.Diagnostico,
                Procedimiento = s.Procedimiento,
                Estado = s.Estado,
                FechaCreacion = s.FechaCreacion,
                FechaProgramada = s.FechaProgramada,
                DiasRestantes = s.DiasRestantes,
                Contactabilidad = s.Contactabilidad ?? "Por Contactar"
            }).ToList();

            Console.WriteLine($"✅ Solicitudes cargadas desde API: {Resumen.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al cargar solicitudes: {ex.Message}");
            // Fallback a datos dummy si falla la API
            CargarDatosDummy();
        }
    }

    // ✅ RESPALDO: Si falla la API, usar datos dummy
    private void CargarDatosDummy()
    {
        Resumen = new List<SolicitudResumenVM>{
            new(){ Id=101, NombrePaciente="María González Pérez", Rut="12.345.678-9", Diagnostico="Fractura de cadera", Procedimiento="Osteosíntesis", Estado="Priorizada", FechaCreacion=DateTime.Now.AddDays(-8) },
            new(){ Id=102, NombrePaciente="Jorge Contreras", Rut="8.765.432-1", Diagnostico="Urgencia diferida", Procedimiento="Evaluación CI", Estado="Pendiente", FechaCreacion=DateTime.Now.AddDays(-5) },
            new(){ Id=103, NombrePaciente="Juan Soto", Rut="5.678.601-2", Diagnostico="Ambulatorio / CRS", Procedimiento="Artroscopía", Estado="Pendiente", FechaCreacion=DateTime.Now.AddDays(-12) },
            new(){ Id=104, NombrePaciente="Ana Torres", Rut="3.456.789-0", Diagnostico="Rechazo de mano", Procedimiento="Revisión", Estado="Pendiente", FechaCreacion=DateTime.Now.AddDays(-15) },
            new(){ Id=105, NombrePaciente="Carlos Ramírez", Rut="98.765.432-1", Diagnostico="Menisco rodilla izq.", Procedimiento="Artroscopía", Estado="Priorizada (Manual)", FechaCreacion=DateTime.Now.AddDays(-7) },
            new(){ Id=106, NombrePaciente="Martín Ramos", Rut="17.654.321-0", Diagnostico="Artroscopía rodilla", Procedimiento="Artroscopía", Estado="Pendiente", FechaCreacion=DateTime.Now.AddDays(-2) },
            new(){ Id=107, NombrePaciente="Ana María P.", Rut="9.111.222-3", Diagnostico="Hernia", Procedimiento="Hernioplastía", Estado="Pendiente", FechaCreacion=DateTime.Now.AddDays(-20) },
            new(){ Id=108, NombrePaciente="Pedro Ruiz", Rut="7.555.111-9", Diagnostico="Cataratas", Procedimiento="Facoemulsificación", Estado="Pendiente", FechaCreacion=DateTime.Now.AddDays(-30) },
        };

        SeedFechasYContacto();
    }

    private void SeedFechasYContacto()
    {
        // Regla simple: programo algunos a 7, 14, 30 días desde hoy
        var hoy = DateTime.Today;
        var turnos = new[] { 7, 14, 30, 45, 60 };
        var contactos = new[] { "Contactado", "Sin Respuesta", "Por Contactar" };
        int i = 0;

        foreach (var s in Resumen)
        {
            // Sólo algunos tienen fecha
            if (i % 2 == 0)
            {
                var plus = turnos[i % turnos.Length];
                s.FechaProgramada = hoy.AddDays(plus);
                s.DiasRestantes = (int)(s.FechaProgramada.Value - hoy).TotalDays;
            }
            else
            {
                s.FechaProgramada = null;
                s.DiasRestantes = null;
            }

            s.Contactabilidad = contactos[i % contactos.Length];
            i++;
        }
    }

    // ===== SLA helpers =====
    // Define tu "ventana" objetivo para SLA (p.ej., 60 días)
    private const int SLA_DIAS = 60;

    private int GetSlaPct(SolicitudResumenVM s)
    {
        if (!s.DiasRestantes.HasValue) return 0;
        var restantes = Math.Clamp(s.DiasRestantes.Value, 0, SLA_DIAS);
        // porcentaje "consumido" (entre 0 y 100, redondeado)
        var pct = (int)Math.Round((double)(SLA_DIAS - restantes) / SLA_DIAS * 100);
        return Math.Clamp(pct, 0, 100);
    }

    private string GetSlaCss(int pct, int? diasRestantes)
    {
        // Verde si quedan >30 días, Amarillo 10–30, Rojo <10
        if (!diasRestantes.HasValue) return "bg-secondary";
        if (diasRestantes.Value > 30) return "sla-ok";
        if (diasRestantes.Value > 10) return "sla-warn";
        return "sla-bad";
    }

    // === NUEVO: Progreso uniforme para programadas ===
    private int GetSlaPctProgramada(SolicitudResumenVM s)
    {
        if (!s.DiasRestantes.HasValue) return 0;
        var restantes = Math.Clamp(s.DiasRestantes.Value, 0, SLA_DIAS);
        var pct = (int)Math.Round((double)(SLA_DIAS - restantes) / SLA_DIAS * 100);
        return Math.Clamp(pct, 0, 100);
    }
}