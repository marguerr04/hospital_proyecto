@layout Components.Layout.RazorVacio
@page "/login"
@using proyecto_hospital_version_1.Services
@using System.Net.Http.Json
@inject AuthStateService AuthStateService
@inject NavigationManager Navigation
@inject HttpClient Http

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <img src="/img/logo_login.png" alt="Logo Hospital" />
        </div>
        <div class="mb-3">
            <label for="username" class="form-label">Usuario</label>
            <input @bind="Username" id="username" class="form-control" />
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input @bind="Password" id="password" type="password" class="form-control" />
        </div>

        @* NUEVO: Selector de roles *@
        <div class="mb-3">
            <label for="role" class="form-label">Rol</label>
            <select @bind="SelectedRole" id="role" class="form-select">
                <option value="">Seleccionar perfil</option>
                <option value="Medico">Médico</option>
                <option value="Administrador">Administrador</option>
            </select>
        </div>

        <button class="btn btn-primary w-100" @onclick="DoLogin" disabled="@_cargando">
            @if (_cargando)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
                <span>Validando...</span>
            }
            else
            {
                <span>Ingresar</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger mt-3">@ErrorMessage</div>
        }

        <div class="login-footer">
            <a href="#">¿Olvidaste tu contraseña?</a>
        </div>
    </div>
</div>

@code {
    private string Username = "";
    private string Password = "";
    private string SelectedRole = "";
    private string ErrorMessage = "";
    private bool _cargando = false;

    private async Task DoLogin()
    {
        ErrorMessage = "";
        _cargando = true;
        StateHasChanged();

        try
        {
            if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password) || string.IsNullOrEmpty(SelectedRole))
            {
                ErrorMessage = "Por favor, complete todos los campos";
                return;
            }

            var loginRequest = new
            {
                Username = Username,
                Password = Password,
                Rol = SelectedRole
            };

            var response = await Http.PostAsJsonAsync("https://localhost:7032/api/Auth/login", loginRequest);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                if (result?.Exito == true)
                {
                    Console.WriteLine($"[Login] Login exitoso. Usuario: {result.Username}, Rol: {result.Rol}");
                    
                    // Guardar estado de autenticación
                    AuthStateService.Login(result.Username!, result.Rol!);
                    
                    Console.WriteLine($"[Login] AuthStateService.IsAuthenticated: {AuthStateService.IsAuthenticated}");

                    // Redirigir según rol (SIN forceLoad para mantener el servicio Scoped)
                    string redirectUrl = result.Rol == "Administrador" ? "/dashboard" : "/home-medico";
                    Console.WriteLine($"[Login] Redirigiendo a: {redirectUrl}");
                    
                    Navigation.NavigateTo(redirectUrl);
                }
                else
                {
                    ErrorMessage = result?.Mensaje ?? "Usuario, contraseña o rol incorrectos";
                }
            }
            else
            {
                ErrorMessage = "Error al comunicarse con el servidor";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"Error en login: {ex}");
        }
        finally
        {
            _cargando = false;
            StateHasChanged();
        }
    }

    private class LoginResponse
    {
        public bool Exito { get; set; }
        public string? Mensaje { get; set; }
        public string? Username { get; set; }
        public string? Rol { get; set; }
    }
}