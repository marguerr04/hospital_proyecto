@layout Components.Layout.RazorVacio
@page "/login"
@using proyecto_hospital_version_1.Services
@using System.Net.Http.Json
@inject AuthStateService AuthStateService
@inject NavigationManager Navigation
@inject HttpClient Http
@inject AuthStateService AuthState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <img src="/img/logo_login.png" alt="Logo Hospital" />
        </div>
        <div class="mb-3">
            <label for="username" class="form-label">Usuario</label>
            <input @bind="Username" id="username" class="form-control" />
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input @bind="Password" id="password" type="password" class="form-control" />
        </div>

        @* NUEVO: Selector de roles *@
        <div class="mb-3">
            <label for="role" class="form-label">Rol</label>
            <select @bind="SelectedRole" id="role" class="form-select">
                <option value="">Seleccionar perfil</option>
                <option value="Medico">Médico</option>
                <option value="Administrador">Administrador</option>
            </select>
        </div>

        <button class="btn btn-primary w-100" @onclick="DoLogin" disabled="@_cargando">
            @if (_cargando)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
                <span>Validando...</span>
            }
            else
            {
                <span>Ingresar</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger mt-3">@ErrorMessage</div>
        }

        <div class="login-footer">
            <a href="#">¿Olvidaste tu contraseña?</a>
        </div>
    </div>
</div>

@code {
    private string Username = "";
    private string Password = "";
    private string SelectedRole = "";
    private string ErrorMessage = "";
    private bool _cargando = false;

    private async Task DoLogin()
    {
        ErrorMessage = "";
        _cargando = true;
        StateHasChanged();

        try
        {
            Console.WriteLine($" [Login] Iniciando login - User: {Username}, Rol: {SelectedRole}");

            if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password) || string.IsNullOrEmpty(SelectedRole))
            {
                ErrorMessage = "Por favor, complete todos los campos";
                return;
            }

            // ✅ Hacer login (esto guarda el token en localStorage)
            bool loginExitoso = await AuthStateService.LoginAsync(Username, Password);

            if (loginExitoso)
            {
                Console.WriteLine($" [Login] Token guardado correctamente");
                Console.WriteLine($"   Usuario: {AuthStateService.Username}");
                Console.WriteLine($"   Rol BD: '{AuthStateService.Role}'");
                Console.WriteLine($"   Rol seleccionado: '{SelectedRole}'");

                // Validar rol
                if (AuthStateService.Role != SelectedRole)
                {
                    Console.WriteLine($"❌ [Login] Rol no coincide");
                    ErrorMessage = $"Rol incorrecto. Tu usuario es '{AuthStateService.Role}', no '{SelectedRole}'";
                    await AuthStateService.LogoutAsync();
                    return;
                }

                // ✅ Redirigir SIN forceLoad
                string redirectUrl = AuthStateService.Role == "Administrador" 
                    ? "/dashboard" 
                    : "/home-medico";

                Console.WriteLine($" [Login] Navegando a: {redirectUrl}");
                
                // ⚠️ IMPORTANTE: NO usar forceLoad: true
                Navigation.NavigateTo(redirectUrl);
            }
            else
            {
                ErrorMessage = "Usuario o contraseña incorrectos";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($" [Login] Error: {ex.Message}");
            ErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _cargando = false;
            StateHasChanged();
        }
    }
}