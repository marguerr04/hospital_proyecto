@page "/priorizar-solicitudes/{SolicitudId:int}"
@using proyecto_hospital_version_1.Shared
@inject NavigationManager Navigation
@layout Components.Layout.MainLayoutMedico
@using proyecto_hospital_version_1.Data._Legacy
@inject HospitalDbContextLegacy HospitalDb
@using Microsoft.EntityFrameworkCore

<PageTitle>Priorizar Solicitud Quirúrgica - Detalle</PageTitle>

<div class="container-fluid mt-4">
    @if (_solicitudSeleccionada == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-hourglass-split me-2"></i>Cargando información de la solicitud...
        </div>
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-outline-secondary" @onclick="VolverALista">
                &larr; Volver a la lista
            </button>
        </div>

        <h3>Detalle y Priorización (ID: @_solicitudSeleccionada.Id)</h3>

        @if (_solicitudSeleccionada.Paciente != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-fill me-2"></i> Información del Paciente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-sm-6">
                                    <strong>Paciente:</strong> @_solicitudSeleccionada.Paciente.primerNombre @_solicitudSeleccionada.Paciente.apellidoPaterno<br>
                                    <strong>RUT:</strong> @_solicitudSeleccionada.Paciente.rut-@_solicitudSeleccionada.Paciente.dv<br>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Diagnóstico:</strong> @_solicitudSeleccionada.DiagnosticoPrincipal<br>
                                    <strong>Procedencia:</strong> <span class="badge bg-primary">@_solicitudSeleccionada.Procedencia</span><br>
                                    <strong>Especialidad:</strong> @_solicitudSeleccionada.EspecialidadOrigen
                                </div>
                            </div>

                            <div class="mt-3">
                                <div class="d-flex align-items-center">
                                    <strong class="me-2">Estado:</strong>
                                    @if (_solicitudSeleccionada.EsGes)
                                    {
                                        <span class="badge bg-danger fs-6">
                                            <i class="bi bi-shield-fill-exclamation me-1"></i> PACIENTE GES
                                        </span>
                                        <small class="text-muted ms-2">(Detectado automáticamente por el sistema)</small>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success fs-6">Paciente No GES</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="timeline-container">
                                <h6 class="mb-2">Línea de Tiempo </h6>
                                <div class="timeline-progress">
                                    <div class="timeline-bar" style="width: @CalcularPorcentajeProgreso()%; background-color: @ObtenerColorProgreso();"></div>
                                </div>
                                <div class="d-flex justify-content-between small text-muted mt-1">
                                    <span>Solicitud<br>@_solicitudSeleccionada.FechaCreacion.ToString("dd/MM/yyyy")</span>
                                    <span class="@ObtenerClaseTextoDias()"><strong>@CalcularDiasTranscurridos() días transcurridos</strong></span>
                                    <span>Hoy<br>@DateTime.Now.ToString("dd/MM/yyyy")</span>
                                </div>
                                <div class="mt-2">
                                    <span class="badge @ObtenerClaseBadge()">
                                        <i class="bi bi-clock me-1"></i> @ObtenerTextoEstado()
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Detalles de la Solicitud</h5>
                <hr />
                <div class="row">
                    <div class="col-md-6">
                        <strong>Diagnóstico:</strong> @_solicitudSeleccionada.DiagnosticoPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>Procedimiento:</strong> @_solicitudSeleccionada.ProcedimientoPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>Procedencia:</strong> @_solicitudSeleccionada.Procedencia
                    </div>
                    <div class="col-md-6">
                        <strong>Es GES:</strong> @(_solicitudSeleccionada.EsGes ? "Sí" : "No")
                    </div>
                    <div class="col-12">
                        <strong>Comorbilidades:</strong> @_solicitudSeleccionada.Comorbilidades
                    </div>
                </div>
            </div>
        </div>

        <!-- Solo mostrar opciones de priorización si está pendiente -->
        @if (_solicitudSeleccionada.Estado == "Pendiente" || string.IsNullOrEmpty(_solicitudSeleccionada.Estado))
        {
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white">
                    Sugerencia del Sistema
                </div>
                <div class="card-body">
                    <h4 class="card-title text-success">Prioridad Sugerida: P@_prioridadSugerida</h4>
                    <p><strong>Motivo:</strong> @_motivoSugerencia</p>
                    <hr />
                    <button class="btn btn-success btn-lg" @onclick="AceptarPrioridad">
                        <i class="bi bi-check-circle me-2"></i> Aceptar y Guardar Prioridad
                    </button>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        Seleccionar Criterio de Priorización Manual
                    </h5>
                </div>
                <div class="card-body">
                    <CriteriosPriorizacion @bind-CriterioSeleccionado="_criterioSeleccionado" />

                    <button class="btn btn-primary mt-3" @onclick="GuardarPrioridadManual"
                            disabled="@(string.IsNullOrEmpty(_criterioSeleccionado))">
                        <i class="bi bi-save me-2"></i> Guardar Prioridad Manual
                    </button>
                </div>
            </div>
        }
        else
        {
            <!-- Mostrar información de priorización existente -->
            <div class="card shadow-sm mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-check-circle me-2"></i>Solicitud Ya Priorizada
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Estado:</strong>
                            <span class="badge bg-success">@_solicitudSeleccionada.Estado</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Prioridad Asignada:</strong>
                            <span class="badge bg-dark">P@_solicitudSeleccionada.Prioridad</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Fecha de Priorización:</strong>
                            @(_solicitudSeleccionada.FechaPriorizacion?.ToString("dd/MM/yyyy HH:mm") ?? "No disponible")
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-warning" @onclick="ReabrirPriorizacion">
                            <i class="bi bi-pencil me-2"></i> Reabrir para Editar
                        </button>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .timeline-container {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
    }

    .timeline-progress {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .timeline-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.4s ease;
    }

    .criterion-group {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .criterion-header {
        background-color: #f8f9fa;
        padding: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .criterion-header:hover {
            background-color: #e9ecef;
        }

    .criterion-content {
        padding: 1rem;
        background-color: white;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
</style>

@code {
    [Parameter] public int SolicitudId { get; set; }

    // Variables para sistema de priorización (SOLO las necesarias para el detalle)
    private SolicitudQuirurgica _solicitudSeleccionada;
    private int _prioridadSugerida = 3;
    private string _motivoSugerencia = "Prioridad base.";
    private string _criterioSeleccionado = "";

    protected override async Task OnParametersSetAsync()
    {
        if (SolicitudId > 0)
        {
            await VerDetalle(SolicitudId);
        }
    }

    private async Task VerDetalle(int id)
    {
        try
        {
            _solicitudSeleccionada = await HospitalDb.SolicitudesQuirurgicas
                .Include(s => s.Paciente)
                .FirstOrDefaultAsync(s => s.Id == id);

            if (_solicitudSeleccionada != null)
            {
                // Calcular prioridad sugerida
                if (_solicitudSeleccionada.Procedencia == "Urgencia")
                {
                    _prioridadSugerida = 1;
                    _motivoSugerencia = "Procedencia es URGENCIA. Máxima prioridad.";
                }
                else if (_solicitudSeleccionada.EsGes)
                {
                    _prioridadSugerida = 2;
                    _motivoSugerencia = "Paciente con patología GES.";
                }
                else
                {
                    _prioridadSugerida = 3;
                    _motivoSugerencia = "Prioridad estándar por orden de llegada.";
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar detalle: {ex.Message}");
        }
    }

    // ==================== MÉTODOS PARA LA LÍNEA DE TIEMPO (60 DÍAS) ====================

    private int CalcularDiasTranscurridos()
    {
        if (_solicitudSeleccionada?.FechaCreacion == null)
            return 0;

        var diferencia = DateTime.Now - _solicitudSeleccionada.FechaCreacion;
        return (int)diferencia.TotalDays;
    }

    private int CalcularPorcentajeProgreso()
    {
        int diasTranscurridos = CalcularDiasTranscurridos();
        int tiempoMaximoEsperado = 60; // 60 días como referencia

        if (tiempoMaximoEsperado == 0) return 0;

        var porcentaje = (diasTranscurridos * 100) / tiempoMaximoEsperado;
        return Math.Min(porcentaje, 100); // No más del 100%
    }

    private string ObtenerColorProgreso()
    {
        int dias = CalcularDiasTranscurridos();

        // Verde: menos de 30 días (menos de la mitad)
        if (dias < 30) return "#28a745";
        // Amarillo: entre 30 y 59 días
        if (dias < 60) return "#ffc107";
        // Rojo: 60 días o más
        return "#dc3545";
    }

    private string ObtenerTextoEstado()
    {
        int dias = CalcularDiasTranscurridos();

        if (dias < 15) return "Reciente";
        if (dias < 30) return "En tiempo";
        if (dias < 45) return "Atención requerida";
        if (dias < 60) return "Urgente";
        return "Crítico - Excedió plazo";
    }

    private string ObtenerClaseBadge()
    {
        int dias = CalcularDiasTranscurridos();

        if (dias < 30) return "bg-success";
        if (dias < 60) return "bg-warning text-dark";
        return "bg-danger";
    }

    private string ObtenerClaseTextoDias()
    {
        int dias = CalcularDiasTranscurridos();

        if (dias < 30) return "text-success";
        if (dias < 60) return "text-warning";
        return "text-danger";
    }

    // ==================== MÉTODOS EXISTENTES ====================

    private async Task AceptarPrioridad()
    {
        try
        {
            _solicitudSeleccionada.Prioridad = _prioridadSugerida;
            _solicitudSeleccionada.Estado = "Priorizada";
            _solicitudSeleccionada.FechaPriorizacion = DateTime.Now;

            HospitalDb.SolicitudesQuirurgicas.Update(_solicitudSeleccionada);
            await HospitalDb.SaveChangesAsync();

            // Recargar para mostrar estado actualizado
            await VerDetalle(SolicitudId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al actualizar: {ex.Message}");
        }
    }

    private async Task GuardarPrioridadManual()
    {
        if (string.IsNullOrEmpty(_criterioSeleccionado) || _solicitudSeleccionada == null)
        {
            Console.WriteLine("No se ha seleccionado un criterio manual o no hay solicitud.");
            return;
        }

        int prioridadManual = 0;
        switch (_criterioSeleccionado)
        {
            case "ges":
            case "logistica":
            case "sanitaria":
                prioridadManual = 1;
                break;
            case "percentil50":
            case "licencia":
            case "prais":
                prioridadManual = 2;
                break;
            case "sename":
            case "comges":
                prioridadManual = 3;
                break;
            default:
                Console.WriteLine($"Criterio no mapeado: '{_criterioSeleccionado}'");
                return;
        }

        if (prioridadManual > 0)
        {
            try
            {
                _solicitudSeleccionada.Prioridad = prioridadManual;
                _solicitudSeleccionada.Estado = "Priorizada (Manual)";
                _solicitudSeleccionada.FechaPriorizacion = DateTime.Now;

                HospitalDb.SolicitudesQuirurgicas.Update(_solicitudSeleccionada);
                await HospitalDb.SaveChangesAsync();

                // Recargar para mostrar estado actualizado
                await VerDetalle(SolicitudId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al guardar prioridad manual: {ex.Message}");
            }
        }
    }

    private async Task ReabrirPriorizacion()
    {
        try
        {
            _solicitudSeleccionada.Estado = "Pendiente";
            _solicitudSeleccionada.Prioridad = 0;
            _solicitudSeleccionada.FechaPriorizacion = null;

            HospitalDb.SolicitudesQuirurgicas.Update(_solicitudSeleccionada);
            await HospitalDb.SaveChangesAsync();

            // Recargar para mostrar opciones de priorización
            await VerDetalle(SolicitudId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al reabrir priorización: {ex.Message}");
        }
    }

    private void VolverALista()
    {
        Navigation.NavigateTo("/priorizar-solicitudes");
    }
}