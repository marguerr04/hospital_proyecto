@page "/priorizar-solicitudes/{SolicitudId:int}"
@using proyecto_hospital_version_1.Shared
@inject NavigationManager Navigation
@layout Components.Layout.MainLayoutMedico
@using proyecto_hospital_version_1.Models
@using proyecto_hospital_version_1.Data._Legacy
@inject HospitalDbContextLegacy HospitalDb
@using Microsoft.EntityFrameworkCore

<PageTitle>Priorizar Solicitud Quirúrgica - Detalle</PageTitle>

<div class="container-fluid mt-4">
    @if (_solicitudSeleccionada == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-hourglass-split me-2"></i>Cargando información de la solicitud...
        </div>
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-outline-secondary" @onclick="VolverALista">
                &larr; Volver a la lista
            </button>
        </div>

        <h3>Detalle y Priorización (ID: @_solicitudSeleccionada.Id)</h3>

        @if (_solicitudSeleccionada.Paciente != null)
        {
            <InfoPacienteCard Paciente="_solicitudSeleccionada.Paciente" />
        }

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Detalles de la Solicitud</h5>
                <hr />
                <div class="row">
                    <div class="col-md-6">
                        <strong>Diagnóstico:</strong> @_solicitudSeleccionada.DiagnosticoPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>Procedimiento:</strong> @_solicitudSeleccionada.ProcedimientoPrincipal
                    </div>
                    <div class="col-md-6">
                        <strong>Procedencia:</strong> @_solicitudSeleccionada.Procedencia
                    </div>
                    <div class="col-md-6">
                        <strong>Es GES:</strong> @(_solicitudSeleccionada.EsGes ? "Sí" : "No")
                    </div>
                    <div class="col-12">
                        <strong>Comorbilidades:</strong> @_solicitudSeleccionada.Comorbilidades
                    </div>
                </div>
            </div>
        </div>

        <!-- Solo mostrar opciones de priorización si está pendiente -->
        @if (_solicitudSeleccionada.Estado == "Pendiente" || string.IsNullOrEmpty(_solicitudSeleccionada.Estado))
        {
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white">
                    Sugerencia del Sistema
                </div>
                <div class="card-body">
                    <h4 class="card-title text-success">Prioridad Sugerida: P@_prioridadSugerida</h4>
                    <p><strong>Motivo:</strong> @_motivoSugerencia</p>
                    <hr />
                    <button class="btn btn-success btn-lg" @onclick="AceptarPrioridad">
                        <i class="bi bi-check-circle me-2"></i> Aceptar y Guardar Prioridad
                    </button>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        Seleccionar Criterio de Priorización Manual
                    </h5>
                </div>
                <div class="card-body">
                    <CriteriosPriorizacion @bind-CriterioSeleccionado="_criterioSeleccionado" />

                    <button class="btn btn-primary mt-3" @onclick="GuardarPrioridadManual"
                            disabled="@(string.IsNullOrEmpty(_criterioSeleccionado))">
                        <i class="bi bi-save me-2"></i> Guardar Prioridad Manual
                    </button>
                </div>
            </div>
        }
        else
        {
            <!-- Mostrar información de priorización existente -->
            <div class="card shadow-sm mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-check-circle me-2"></i>Solicitud Ya Priorizada
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Estado:</strong>
                            <span class="badge bg-success">@_solicitudSeleccionada.Estado</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Prioridad Asignada:</strong>
                            <span class="badge bg-dark">P@_solicitudSeleccionada.Prioridad</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Fecha de Priorización:</strong>
                            @(_solicitudSeleccionada.FechaPriorizacion?.ToString("dd/MM/yyyy HH:mm") ?? "No disponible")
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-warning" @onclick="ReabrirPriorizacion">
                            <i class="bi bi-pencil me-2"></i> Reabrir para Editar
                        </button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public int SolicitudId { get; set; }

    // Variables para sistema de priorización (SOLO las necesarias para el detalle)
    private SolicitudQuirurgica _solicitudSeleccionada;
    private int _prioridadSugerida = 3;
    private string _motivoSugerencia = "Prioridad base.";
    private string _criterioSeleccionado = "";

    protected override async Task OnParametersSetAsync()
    {
        if (SolicitudId > 0)
        {
            await VerDetalle(SolicitudId);
        }
    }

    private async Task VerDetalle(int id)
    {
        try
        {
            _solicitudSeleccionada = await HospitalDb.SolicitudesQuirurgicas
                .Include(s => s.Paciente)
                .FirstOrDefaultAsync(s => s.Id == id);

            if (_solicitudSeleccionada != null)
            {
                // Calcular prioridad sugerida
                if (_solicitudSeleccionada.Procedencia == "Urgencia")
                {
                    _prioridadSugerida = 1;
                    _motivoSugerencia = "Procedencia es URGENCIA. Máxima prioridad.";
                }
                else if (_solicitudSeleccionada.EsGes)
                {
                    _prioridadSugerida = 2;
                    _motivoSugerencia = "Paciente con patología GES.";
                }
                else
                {
                    _prioridadSugerida = 3;
                    _motivoSugerencia = "Prioridad estándar por orden de llegada.";
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar detalle: {ex.Message}");
        }
    }

    private async Task AceptarPrioridad()
    {
        try
        {
            _solicitudSeleccionada.Prioridad = _prioridadSugerida;
            _solicitudSeleccionada.Estado = "Priorizada";
            _solicitudSeleccionada.FechaPriorizacion = DateTime.Now;

            HospitalDb.SolicitudesQuirurgicas.Update(_solicitudSeleccionada);
            await HospitalDb.SaveChangesAsync();

            // Recargar para mostrar estado actualizado
            await VerDetalle(SolicitudId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al actualizar: {ex.Message}");
        }
    }

    private async Task GuardarPrioridadManual()
    {
        if (string.IsNullOrEmpty(_criterioSeleccionado) || _solicitudSeleccionada == null)
        {
            Console.WriteLine("No se ha seleccionado un criterio manual o no hay solicitud.");
            return;
        }

        int prioridadManual = 0;
        switch (_criterioSeleccionado)
        {
            case "ges":
            case "logistica":
            case "sanitaria":
                prioridadManual = 1;
                break;
            case "percentil50":
            case "licencia":
            case "prais":
                prioridadManual = 2;
                break;
            case "sename":
            case "comges":
                prioridadManual = 3;
                break;
            default:
                Console.WriteLine($"Criterio no mapeado: '{_criterioSeleccionado}'");
                return;
        }

        if (prioridadManual > 0)
        {
            try
            {
                _solicitudSeleccionada.Prioridad = prioridadManual;
                _solicitudSeleccionada.Estado = "Priorizada (Manual)";
                _solicitudSeleccionada.FechaPriorizacion = DateTime.Now;

                HospitalDb.SolicitudesQuirurgicas.Update(_solicitudSeleccionada);
                await HospitalDb.SaveChangesAsync();

                // Recargar para mostrar estado actualizado
                await VerDetalle(SolicitudId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al guardar prioridad manual: {ex.Message}");
            }
        }
    }

    private async Task ReabrirPriorizacion()
    {
        try
        {
            _solicitudSeleccionada.Estado = "Pendiente";
            _solicitudSeleccionada.Prioridad = 0;
            _solicitudSeleccionada.FechaPriorizacion = null;

            HospitalDb.SolicitudesQuirurgicas.Update(_solicitudSeleccionada);
            await HospitalDb.SaveChangesAsync();

            // Recargar para mostrar opciones de priorización
            await VerDetalle(SolicitudId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al reabrir priorización: {ex.Message}");
        }
    }

    private void VolverALista()
    {
        Navigation.NavigateTo("/priorizar-solicitudes");
    }
}