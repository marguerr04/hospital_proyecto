@page "/dashboard_verdadero"
@using MudBlazor
@using proyecto_hospital_version_1.Services
@using System.Text
@using System.Globalization
@inject DashboardService dashboard
@inject IJSRuntime JS

<PageTitle>Panel de Control - Administración Hospitalaria</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6 mb-8">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true" Class="mb-1 text-primary">
        🏥 Panel de Gestión Clínica
    </MudText>
    <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-6 text-secondary">
        Unidad de Control de Gestión · @DateTime.Now.ToString("dd/MM/yyyy")
    </MudText>

    <!-- Tarjetas superiores -->
    <MudGrid Justify="Justify.Center" Spacing="3">
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4 text-center dashboard-card">
                <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.h6" Class="mt-2 text-primary">Percentil 75</MudText>
                <MudText Typo="Typo.h4" Class="fw-bold mt-1">@Percentil75</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary mt-1">Casos analizados</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4 text-center dashboard-card">
                <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Large" Color="Color.Error" />
                <MudText Typo="Typo.h6" Class="mt-2 text-error">Reducción</MudText>
                <MudText Typo="Typo.h4" Class="fw-bold mt-1">@Reduccion%</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary mt-1">Comparado al mes anterior</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4 text-center dashboard-card">
                <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large" Color="Color.Info" />
                <MudText Typo="Typo.h6" Class="mt-2 text-info">Pendientes</MudText>
                <MudText Typo="Typo.h4" Class="fw-bold mt-1">@Pendientes</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary mt-1">Casos por revisar</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-4">
        <!-- Gráfico de Estados -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <canvas id="chartEstado"></canvas>
            </MudPaper>
        </MudItem>
        <!-- Gráfico de Contactabilidad -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <canvas id="chartContacto"></canvas>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int Percentil75;
    private int Reduccion;
    private int Pendientes;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Percentil75 = await dashboard.ObtenerPercentil75Async();
            Reduccion = await dashboard.ObtenerReduccionAsync();
            Pendientes = await dashboard.ObtenerPendientesAsync();

            var estadoDic = await dashboard.ObtenerProcedimientosPorTipoAsync();
            var contactoDic = await dashboard.ObtenerPorcentajeContactoAsync();

            if (estadoDic?.Any() == true)
                await JS.InvokeVoidAsync("dashboardCharts.renderBar", "chartEstado",
                                         estadoDic.Keys.ToArray(),
                                         estadoDic.Values.ToArray(),
                                         new[] { "rgba(25,118,210,0.85)" });

            if (contactoDic?.Any() == true)
                await JS.InvokeVoidAsync("dashboardCharts.renderDonut", "chartContacto",
                                         contactoDic.Keys.ToArray(),
                                         contactoDic.Values.ToArray(),
                                         new[] { "rgba(25,118,210,0.85)" });

        }
        catch (Exception ex)
        {
            Console.WriteLine("Error cargando dashboard: " + ex.Message);
        }
    }
}
