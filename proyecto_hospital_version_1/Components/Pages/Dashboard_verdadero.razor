@page "/dashboard_verdadero"
@using MudBlazor
@using proyecto_hospital_version_1.Services
@using System.Text
@using System.Globalization
@using Microsoft.JSInterop
@inject DashboardService dashboard
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Panel de Control - Administración Hospitalaria</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6 mb-8">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true" Class="mb-1 text-primary">
        🏥 Panel de Gestión Clínica
    </MudText>
    <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-6 text-secondary">
        Unidad de Control de Gestión · @DateTime.Now.ToString("dd/MM/yyyy")
    </MudText>

    <!-- BARRA DE FILTROS SIMPLE -->
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudDateRangePicker @bind-DateRange="dateRange" Label="Rango fechas" Dense="true" />
                    <MudSelect T="string" @bind-Value="sexoFilter" Label="Sexo" Dense="true" Style="min-width:120px">
                        <MudSelectItem Value="Todos">Todos</MudSelectItem>
                        <MudSelectItem Value="M">Masculino</MudSelectItem>
                        <MudSelectItem Value="F">Femenino</MudSelectItem>
                    </MudSelect>
                    <MudSelect T="string" @bind-Value="gesFilter" Label="GES" Dense="true" Style="min-width:120px">
                        <MudSelectItem Value="Todos">Todos</MudSelectItem>
                        <MudSelectItem Value="GES">GES</MudSelectItem>
                        <MudSelectItem Value="NoGES">No GES</MudSelectItem>
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(async ()=> await ActualizarDatos())">Aplicar</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- TARJETAS SUPERIORES KPI -->
    <MudGrid Justify="Justify.Center" Spacing="3" Class="mt-4">
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4 text-center dashboard-card">
                <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.h6" Class="mt-2 text-primary">Percentil 75</MudText>
                <MudText Typo="Typo.h4" Class="fw-bold mt-1">@Percentil75</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary mt-1">Casos analizados</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4 text-center dashboard-card">
                <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Large" Color="Color.Error" />
                <MudText Typo="Typo.h6" Class="mt-2 text-error">Reducción</MudText>
                <MudText Typo="Typo.h4" Class="fw-bold mt-1">@Reduccion%</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary mt-1">Comparado al mes anterior</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4 text-center dashboard-card">
                <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large" Color="Color.Info" />
                <MudText Typo="Typo.h6" Class="mt-2 text-info">Pendientes</MudText>
                <MudText Typo="Typo.h4" Class="fw-bold mt-1">@Pendientes</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary mt-1">Casos por revisar</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- SECCIÓN PRINCIPAL: TABLA + GRÁFICOS -->
    <MudGrid Class="mt-3" Spacing="1">
        <!-- Columna Izquierda: Tabla de Procedimientos -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-2">
                <MudText Typo="Typo.h6">Tabla de procedimientos</MudText>
                <MudTable Dense="true" Items="procedimientosList" Hover="true" Bordered="true">
                    <HeaderContent>
                        <MudTh>Procedimiento</MudTh>
                        <MudTh>Casos</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Key</MudTd>
                        <MudTd>@context.Value</MudTd>
                        <MudTd>
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@( async ()=> await OpenDetail(context.Key, context.Value) )">Ver evolución</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>

        <!-- Columna Derecha: 4 Gráficos -->
        <MudItem xs="12" md="8">
            <MudGrid Spacing="1" Class="gx-1 gy-1">
                <!-- Procedimientos (barras) -->
                <MudItem xs="12" sm="6" Class="chart-grid-item">
                    <MudPaper Class="pa-2" Style="height:220px;">
                        <MudText Typo="Typo.subtitle2">Procedimientos</MudText>
                        <div style="height:180px;">
                            <canvas id="chartEstado"></canvas>
                        </div>
                    </MudPaper>
                </MudItem>

                <!-- Contactabilidad (donut) -->
                <MudItem xs="12" sm="6" Class="chart-grid-item">
                    <MudPaper Class="pa-2" Style="height:220px;">
                        <MudText Typo="Typo.subtitle2">Contactabilidad</MudText>
                        <div style="height:180px;">
                            <canvas id="chartContacto"></canvas>
                        </div>
                    </MudPaper>
                </MudItem>

                <!-- Evolución Percentil (línea) -->
                <MudItem xs="12" sm="6" Class="chart-grid-item">
                    <MudPaper Class="pa-2" Style="height:220px;">
                        <MudText Typo="Typo.subtitle2">Evolución Percentil 75</MudText>
                        <div style="height:180px;">
                            <canvas id="chartEvolucion"></canvas>
                        </div>
                    </MudPaper>
                </MudItem>

                <!-- Causal de Egreso (pie) -->
                <MudItem xs="12" sm="6" Class="chart-grid-item">
                    <MudPaper Class="pa-2" Style="height:220px;">
                        <MudText Typo="Typo.subtitle2">Causal de Egreso</MudText>
                        <div style="height:180px;">
                            <canvas id="chartEgreso"></canvas>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>
    </MudGrid>

    <!-- Area de detalle / evolución de procedimiento -->
    @if (showProcedureDetail)
    {
        <MudGrid Class="mt-3">
            <MudItem xs="12">
                <MudPaper Class="pa-3" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifySpaceBetween">
                        <MudText Typo="Typo.subtitle1">Evolución: @selectedProcedureName (@selectedProcedureValue)</MudText>
                        <MudButton Color="Color.Primary" Variant="Variant.Text" OnClick="@( async ()=> { showProcedureDetail = false; await InvokeAsync(StateHasChanged); })">Cerrar</MudButton>
                    </MudStack>
                    <div style="height:320px;" class="mt-2">
                        <canvas id="chartProcedimientoEvolucion"></canvas>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private int Percentil75;
    private int Reduccion;
    private int Pendientes;
    // inicia por defecto con periodo de 1 mes atrás hasta hoy
    private DateRange dateRange = new DateRange(DateTime.Today.AddMonths(-1), DateTime.Today);
    private string sexoFilter = "Todos";
    private string gesFilter = "Todos";
    private List<KeyValuePair<string,int>> procedimientosList = new();
    private bool _isLoading = false;
    private CancellationTokenSource _cts = new();

    private DotNetObjectReference<Dashboard_verdadero>? _dotNetRef;

    // Detalle / evolución de procedimiento seleccionado
    private string? selectedProcedureName;
    private int selectedProcedureValue;
    private bool showProcedureDetail = false;

    protected override async Task OnInitializedAsync()
    {
        await ActualizarDatos();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("dashboardCharts.registerDotNet", _dotNetRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"⚠️ No fue posible registrar DotNet en JS: {ex.Message}");
            }
        }
    }

    private async Task ActualizarDatos()
    {
        if (_isLoading) return; // Prevenir múltiples ejecuciones simultáneas
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;

        try
        {
            if (_cts.IsCancellationRequested)
            {
                _cts.Dispose();
                _cts = new CancellationTokenSource();
            }

            var token = _cts.Token;

            // KPIs básicos
            Percentil75 = await dashboard.ObtenerPercentil75Async();
            if (token.IsCancellationRequested) return;

            Reduccion = await dashboard.ObtenerReduccionAsync();
            if (token.IsCancellationRequested) return;

            Pendientes = await dashboard.ObtenerPendientesAsync();
            if (token.IsCancellationRequested) return;

            // filtros
            var desde = dateRange.Start;
            var hasta = dateRange.End;
            string? sexoParam = sexoFilter == "Todos" ? null : sexoFilter;
            bool? gesParam = gesFilter == "Todos" ? null : (gesFilter == "GES" ? true : (bool?)false);

            // cargar datos
            var procedimientos = await dashboard.ObtenerProcedimientosPorTipoAsync(desde, hasta, sexoParam, gesParam);
            if (token.IsCancellationRequested) return;

            var contactabilidad = await dashboard.ObtenerContactabilidadAsync(desde, hasta, sexoParam, gesParam);
            if (token.IsCancellationRequested) return;

            var evolucion = await dashboard.ObtenerEvolucionPercentilAsync(desde, hasta, sexoParam, gesParam);
            if (token.IsCancellationRequested) return;

            var causales = await dashboard.ObtenerCausalEgresoAsync(desde, hasta, sexoParam, gesParam);
            if (token.IsCancellationRequested) return;

            // renderizamos
            await InvokeAsync(StateHasChanged);
            await Task.Delay(150, token);

            if (procedimientos?.Any() == true && !token.IsCancellationRequested)
            {
                try
                {
                    var labels = procedimientos.Keys.ToArray();
                    var data = procedimientos.Values.Select(v => (double)v).ToArray();
                    var colors = GenerarColores(procedimientos.Count);

                    await JS.InvokeVoidAsync("dashboardCharts.renderBar", "chartEstado", labels, data, new { backgroundColor = colors, label = "Casos" });
                    procedimientosList = procedimientos.Select(kv => new KeyValuePair<string,int>(kv.Key, kv.Value)).ToList();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"⚠️ Error renderizando gráfico Estados: {ex.Message}");
                }
            }

            if (contactabilidad?.Any() == true && !token.IsCancellationRequested)
            {
                try
                {
                    var labels = contactabilidad.Keys.ToArray();
                    var data = contactabilidad.Values.ToArray();
                    var colors = GenerarColores(contactabilidad.Count);

                    await JS.InvokeVoidAsync("dashboardCharts.renderDonut", "chartContacto", labels, data, colors);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"⚠️ Error renderizando gráfico Contactabilidad: {ex.Message}");
                }
            }

            if (evolucion?.Any() == true && !token.IsCancellationRequested)
            {
                try
                {
                    var labels = evolucion.Select(e => e.Mes).ToArray();
                    var data = evolucion.Select(e => (double)e.Valor).ToArray();
                    var options = new { label = "Percentil 75" };

                    await JS.InvokeVoidAsync("dashboardCharts.renderLine", "chartEvolucion", labels, data, options);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"⚠️ Error renderizando gráfico Evolución: {ex.Message}");
                }
            }

            if (causales?.Any() == true && !token.IsCancellationRequested)
            {
                try
                {
                    var labels = causales.Keys.ToArray();
                    var data = causales.Values.Select(v => (double)v).ToArray();
                    var colors = GenerarColores(causales.Count);

                    await JS.InvokeVoidAsync("dashboardCharts.renderPie", "chartEgreso", labels, data, colors);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"⚠️ Error renderizando gráfico Causales: {ex.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error actualizando datos: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            try { await InvokeAsync(StateHasChanged); } catch { }
        }
    }

    private async Task OpenDetail(string label, int value)
    {
        try
        {
            selectedProcedureName = label;
            selectedProcedureValue = value;
            showProcedureDetail = true;
            await InvokeAsync(StateHasChanged);

            var desde = dateRange.Start;
            var hasta = dateRange.End;
            string? sexoParam = sexoFilter == "Todos" ? null : sexoFilter;
            bool? gesParam = gesFilter == "Todos" ? null : (gesFilter == "GES" ? true : (bool?)false);

            var evolucionProcedimiento = await dashboard.ObtenerEvolucionProcedimientoAsync(
                label,
                desde,
                hasta,
                sexoParam,
                gesParam
            );

            await InvokeAsync(StateHasChanged);
            await Task.Delay(120);

            if (evolucionProcedimiento != null && evolucionProcedimiento.Any())
            {
                var labels = evolucionProcedimiento.Select(e => e.Fecha).ToArray();
                var data = evolucionProcedimiento.Select(e => (double)e.Cantidad).ToArray();
                await JS.InvokeVoidAsync("dashboardCharts.renderLine",
                    "chartProcedimientoEvolucion", labels, data, new { label = $"Evolución {label}" });
            }

            await JS.InvokeVoidAsync("dashboardCharts.showDetail", label, value, sexoFilter, gesFilter);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error abriendo detalle: {ex.Message}");
        }
    }

    [JSInvokable("OnChartPointClicked")]
    public async Task OnChartPointClicked(string chartId, string label, int value)
    {
        await OpenDetail(label, value);
    }

    private string[] GenerarColores(int cantidad)
    {
        (int r, int g, int b)[] paletaRgb = new (int, int, int)[]
        {
            (25,118,210), (229,57,53), (67,160,71), (251,192,45), (142,36,170),
            (255,87,34), (0,172,193), (192,202,51), (255,152,0), (123,31,162)
        };

        string[] colores = new string[cantidad];
        for (int i = 0; i < cantidad; i++)
        {
            var (r, g, b) = paletaRgb[i % paletaRgb.Length];
            colores[i] = $"rgba({r},{g},{b},0.85)";
        }
        return colores;
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
        _dotNetRef?.Dispose();
    }
}
