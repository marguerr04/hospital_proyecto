@page "/dashboard"
@using proyecto_hospital_version_1.Shared
@using proyecto_hospital_version_1.Components.Shared
@using proyecto_hospital_version_1.Services
@inject NavigationManager Navigation
@inject AuthStateService AuthStateService
@inject HttpClient Http
@inject IJSRuntime JS
@inject PriorizacionApiService PriorizacionApi
@inject ISolicitudQuirurgicaApiService SolicitudApi
@inject IProfesionalApiService ProfesionalApi
@using Hospital.Api.DTOs

<PageTitle>Panel de Trabajo Quirúrgico</PageTitle>

@if (!AuthStateService.IsAuthenticated)
{
    <div style="display: none;">Redirigiendo...</div>
}
else
{
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3 mb-0">Panel de Control Administrativo – LEQ No GES</h1>
                <small class="text-muted">Monitoreo de calidad de datos y estado de solicitudes – Hospítals Padre Hurtado</small>
            </div>
        </div>

        <!-- Cards de KPIs -->
        <div class="row g-3 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 kpi-card kpi-card-primary h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted mb-2">Solicitudes Activas</h6>
                                <h2 class="kpi-value text-primary mb-0">@_solicitudesActivas.ToString("N0")</h2>
                                <small class="text-primary" style="opacity: 0.7; font-size: 0.75rem;">En procesamiento</small>
                            </div>
                            <i class="bi bi-file-earmark-check text-primary" style="font-size: 2rem; opacity: 0.6;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 kpi-card kpi-card-warning h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted mb-2">Pendientes de Priorización</h6>
                                <h2 class="kpi-value text-warning mb-0">@_pendientesPriorizacion.ToString("N0")</h2>
                                <small class="text-warning" style="opacity: 0.7; font-size: 0.75rem;">Requieren acción</small>
                            </div>
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 2rem; opacity: 0.6;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 kpi-card kpi-card-danger h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted mb-2">Datos Incompletos</h6>
                                <h2 class="kpi-value text-danger mb-0">@_datosIncompletos</h2>
                                <small class="text-danger" style="opacity: 0.7; font-size: 0.75rem;">Faltan documentos</small>
                            </div>
                            <i class="bi bi-exclamation-circle text-danger" style="font-size: 2rem; opacity: 0.6;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 kpi-card kpi-card-success h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-muted mb-2">Duplicados Denegados</h6>
                                <h2 class="kpi-value text-success mb-0">@_duplicadosDenegados</h2>
                                <small class="text-success" style="opacity: 0.7; font-size: 0.75rem;">Rechazados</small>
                            </div>
                            <i class="bi bi-ban text-success" style="font-size: 2rem; opacity: 0.6;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 📊 Gráfico de Solicitudes Recientes Ingresadas -->
        <div class="row mb-3">
            <!-- Columna del Gráfico: 8/12 -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-3">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-file-earmark-medical me-2 icon-header"></i>
                            Solicitudes Ingresadas por Día (Últimos 7 días)
                        </h5>
                        @if (_cargandoSolicitudesRecientes)
                        {
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 mb-0">Cargando solicitudes recientes...</p>
                            </div>
                        }
                        else
                        {
                            <div style="position: relative; height: 300px;">
                                <canvas id="chartSolicitudesRecientes"></canvas>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Columna de Botones de Navegación: 4/12 -->
            <div class="col-lg-4">
                <div class="d-flex flex-column h-100" style="gap: 1rem;">
                    <!-- Botón Dashboard Analítico -->
                    <div class="card shadow-sm border-0 flex-fill dashboard-nav-btn" 
                         style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); cursor: pointer; min-height: 0;"
                         @onclick="IrAlDashboardAnalítico">
                        <div class="card-body d-flex flex-column align-items-center justify-content-center text-white h-100 p-3">
                            <i class="bi bi-graph-up-arrow" style="font-size: 3rem; opacity: 0.9;"></i>
                            <h5 class="mt-3 mb-1 fw-bold">Dashboard Analítico</h5>
                            <small class="text-center" style="opacity: 0.9;">Ver análisis y métricas</small>
                        </div>
                    </div>

                    <!-- Botón Historial de Logs -->
                    <div class="card shadow-sm border-0 flex-fill dashboard-nav-btn" 
                         style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); cursor: pointer; min-height: 0;"
                         @onclick="IrAlHistorialLogs">
                        <div class="card-body d-flex flex-column align-items-center justify-content-center text-white h-100 p-3">
                            <i class="bi bi-clock-history" style="font-size: 3rem; opacity: 0.9;"></i>
                            <h5 class="mt-3 mb-1 fw-bold">Historial de Logs</h5>
                            <small class="text-center" style="opacity: 0.9;">Ver registros de priorizaciones</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nueva estructura: Grid 6/12 + 6/12 -->
        <div class="row mb-3">
            <!-- Columna izquierda: Buscador de pacientes (6/12) -->
            <div class="col-lg-6">
                <!-- Card del Buscador -->
                <div class="card shadow-sm border-0 search-card mb-3">
                    <div class="card-body p-3">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-search me-2 icon-header"></i>
                            Buscar Paciente
                        </h5>
                        <div>
                            <BuscadorPaciente OnPacienteEncontrado="HandlePacienteSeleccionado" />
                        </div>
                    </div>
                </div>

                <!-- Cards desplegables (alineadas con el buscador) -->
                <!-- Card 1: Información del Paciente -->
                <div class="card shadow-sm border-primary mb-3 @(_pacienteSeleccionado == null ? "opacity-50" : "")" 
                     @onclick="AbrirModalInfoPaciente"
                     style="@(_pacienteSeleccionado == null ? "cursor: not-allowed;" : "cursor: pointer;")">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-0 text-primary d-flex align-items-center">
                                    <i class="bi bi-person-badge me-2"></i>
                                    Información del Paciente
                                </h6>
                                @if (_pacienteSeleccionado != null)
                                {
                                    <small class="text-muted d-block mt-1">
                                        @_pacienteSeleccionado.PrimerNombre @_pacienteSeleccionado.ApellidoPaterno - RUT: @_pacienteSeleccionado.Rut-@_pacienteSeleccionado.Dv
                                    </small>
                                }
                                else
                                {
                                    <small class="text-secondary d-block mt-1">
                                        <i class="bi bi-info-circle me-1"></i>Selecciona un paciente para ver información
                                    </small>
                                }
                            </div>
                            <i class="bi bi-chevron-down text-primary ms-2"></i>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Alertas Clínicas -->
                <div class="card shadow-sm border-danger mb-3 @(_pacienteSeleccionado == null ? "opacity-50" : "")" 
                     @onclick="AbrirModalAlertasClinicas"
                     style="@(_pacienteSeleccionado == null ? "cursor: not-allowed;" : "cursor: pointer;")">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-0 text-danger d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Alertas Clínicas
                                </h6>
                                @if (_pacienteSeleccionado != null)
                                {
                                    <small class="text-muted d-block mt-1">
                                        Ver alertas y condiciones médicas
                                    </small>
                                }
                                else
                                {
                                    <small class="text-secondary d-block mt-1">
                                        <i class="bi bi-info-circle me-1"></i>Selecciona un paciente para ver alertas
                                    </small>
                                }
                            </div>
                            <i class="bi bi-chevron-down text-danger ms-2"></i>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Solicitudes Quirúrgicas -->
                <div class="card shadow-sm border-success @(_pacienteSeleccionado == null ? "opacity-50" : "")" 
                     @onclick="AbrirModalSolicitudes"
                     style="@(_pacienteSeleccionado == null ? "cursor: not-allowed;" : "cursor: pointer;")">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-0 text-success d-flex align-items-center">
                                    <i class="bi bi-clipboard2-pulse me-2"></i>
                                    Solicitudes Quirúrgicas
                                </h6>
                                @if (_pacienteSeleccionado != null)
                                {
                                    <small class="text-muted d-block mt-1">
                                        Ver historial de solicitudes
                                    </small>
                                }
                                else
                                {
                                    <small class="text-secondary d-block mt-1">
                                        <i class="bi bi-info-circle me-1"></i>Selecciona un paciente para ver solicitudes
                                    </small>
                                }
                            </div>
                            <i class="bi bi-chevron-down text-success ms-2"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Buscador + Tabla de Profesionales Médicos (6/12) -->
            <div class="col-lg-6">
                <div class="card shadow-sm border-0 professional-card h-100">
                    <div class="card-body p-3">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-stethoscope me-2 icon-header"></i>
                            Profesionales Médicos
                        </h5>

                        <!-- Buscador de Profesionales -->
                        <div class="mb-3">
                            <BuscadorProfesional OnProfesionalEncontrado="HandleProfesionalSeleccionado" />
                        </div>

                        <!-- Tabla de Profesionales con Paginación -->
                        @if (_profesionalesPaginados?.Any() == true)
                        {
                            <div class="table-responsive">
                                <table class="table table-hover table-sm enhanced-table">
                                    <thead class="table-header-enhanced">
                                        <tr>
                                            <th>
                                                <i class="bi bi-person-fill me-1"></i>
                                                Nombre Completo
                                            </th>
                                            <th>
                                                <i class="bi bi-credit-card-2-front me-1"></i>
                                                RUT
                                            </th>
                                            <th>
                                                <i class="bi bi-briefcase-fill me-1"></i>
                                                Rol
                                            </th>
                                            <th>
                                                <i class="bi bi-clipboard2 me-1"></i>
                                                Especialidad
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var profesional in _profesionalesPaginados)
                                        {
                                            <tr class="table-row-enhanced @(_profesionalSeleccionado?.Id == profesional.Id ? "table-active" : "")">
                                                <td class="fw-500">@profesional.NombreCompleto</td>
                                                <td><span class="badge bg-light text-dark">@profesional.RutCompleto</span></td>
                                                <td><span class="badge bg-primary">@profesional.Rol</span></td>
                                                <td><span class="badge bg-success">@profesional.Especialidad</span></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Paginación -->
                            @if (_totalPaginasProfesionales > 1)
                            {
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        Mostrando @((_paginaActualProfesionales - 1) * _itemsPorPaginaProfesionales + 1) 
                                        - @(Math.Min(_paginaActualProfesionales * _itemsPorPaginaProfesionales, _totalProfesionales)) 
                                        de @_totalProfesionales profesionales
                                    </small>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                @onclick="PaginaAnteriorProfesionales"
                                                disabled="@(_paginaActualProfesionales <= 1)">
                                            <i class="bi bi-chevron-left"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" disabled>
                                            @_paginaActualProfesionales / @_totalPaginasProfesionales
                                        </button>
                                        <button class="btn btn-outline-primary" 
                                                @onclick="PaginaSiguienteProfesionales"
                                                disabled="@(_paginaActualProfesionales >= _totalPaginasProfesionales)">
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                        else if (_cargando)
                        {
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 mb-0">Cargando profesionales...</p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning text-center mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                No se encontraron profesionales.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (_mostrarInfoPaciente && _pacienteSeleccionado != null)
    {
        <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
        <div class="modal fade show d-block" style="z-index: 1055;" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-person-badge me-2"></i>
                            Información Completa del Paciente
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalInfoPaciente"></button>
                    </div>
                    <div class="modal-body">
                        @if (_pacienteSeleccionado != null)
                        {
                            <InfoPacienteCard Paciente="_pacienteSeleccionado" />
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalInfoPaciente">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (_mostrarAlertasClinicas && _pacienteSeleccionado != null)
    {
        <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
        <div class="modal fade show d-block" style="z-index: 1055;" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Alertas Clínicas del Paciente
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalAlertasClinicas"></button>
                    </div>
                    <div class="modal-body">
                        @if (_pacienteSeleccionado != null)
                        {
                            <AlertasClinicasCard Paciente="_pacienteSeleccionado" />
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalAlertasClinicas">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (_mostrarSolicitudes && _pacienteSeleccionado != null)
    {
        <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
        <div class="modal fade show d-block" style="z-index: 1055; max-height: 90vh; overflow: hidden;" tabindex="-1">
            <div class="modal-dialog modal-xl" style="max-height: 85vh;">
                <div class="modal-content" style="max-height: 85vh;">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-clipboard2-pulse me-2"></i>
                            Solicitudes Quirúrgicas - @_pacienteSeleccionado.PrimerNombre @_pacienteSeleccionado.ApellidoPaterno
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalSolicitudes"></button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
                        @if (_cargandoSolicitudes)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 text-muted">Cargando solicitudes...</p>
                            </div>
                        }
                        else if (_solicitudesPendientes?.Any() == true || _solicitudesPriorizadas?.Any() == true || _solicitudesEgresadas?.Any() == true)
                        {
                            @if (_solicitudesPriorizadas?.Any() == true)
                            {
                                <div class="card shadow-sm border-success mb-4">
                                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-check-circle me-2"></i>
                                            Solicitudes Priorizadas
                                        </h6>
                                        <span class="badge bg-light text-dark">@_solicitudesPriorizadas.Count</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Procedimiento</th>
                                                        <th>Diagnóstico</th>
                                                        <th>Prioridad</th>
                                                        <th>Fecha</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var solicitud in ObtenerSolicitudesActuales(_solicitudesPriorizadas))
                                                    {
                                                        <tr>
                                                            <td class="fw-bold">@solicitud.Id</td>
                                                            <td>@solicitud.Procedimiento</td>
                                                            <td>@solicitud.Diagnostico</td>
                                                            <td>
                                                                @{
                                                                    var autoridad = solicitud.Prioridad ?? 3;
                                                                }
                                                                @if (autoridad == 1)
                                                                {
                                                                    <span class="badge bg-danger">P1</span>
                                                                }
                                                                else if (autoridad == 2)
                                                                {
                                                                    <span class="badge bg-warning text-dark">P2</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-primary">P@autoridad</span>
                                                                }
                                                            </td>
                                                            <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (_solicitudesPendientes?.Any() == true)
                            {
                                <div class="card shadow-sm border-warning mb-4">
                                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-clock me-2"></i>
                                            Solicitudes Pendientes
                                        </h6>
                                        <span class="badge bg-light text-dark">@_solicitudesPendientes.Count</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Procedimiento</th>
                                                        <th>Diagnóstico</th>
                                                        <th>Estado</th>
                                                        <th>Fecha</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var solicitud in ObtenerSolicitudesActuales(_solicitudesPendientes))
                                                    {
                                                        <tr>
                                                            <td class="fw-bold">@solicitud.Id</td>
                                                            <td>@solicitud.Procedimiento</td>
                                                            <td>@solicitud.Diagnostico</td>
                                                            <td><span class="badge bg-secondary">Pendiente</span></td>
                                                            <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (_solicitudesEgresadas?.Any() == true)
                            {
                                <div class="card shadow-sm border-info">
                                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-check2-all me-2"></i>
                                            Solicitudes Egresadas
                                        </h6>
                                        <span class="badge bg-light text-dark">@_solicitudesEgresadas.Count</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Procedimiento</th>
                                                        <th>Diagnóstico</th>
                                                        <th>Estado</th>
                                                        <th>Fecha Egreso</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var solicitud in ObtenerSolicitudesActuales(_solicitudesEgresadas))
                                                    {
                                                        <tr>
                                                            <td class="fw-bold">@solicitud.Id</td>
                                                            <td>@solicitud.Procedimiento</td>
                                                            <td>@solicitud.Diagnostico</td>
                                                            <td><span class="badge bg-success">Egresado</span></td>
                                                            <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-clipboard-x text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No se encontraron solicitudes quirúrgicas para este paciente.</p>
                            </div>
                        }
                    </div>
                    <div class="modal-footer d-flex justify-content-between align-items-center">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    @onclick="IrAPaginaAnterior"
                                    disabled="@(_paginaActual <= 1)">
                                Anterior
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" disabled="true">
                                Página @_paginaActual de @ObtenerTotalPaginas(ObtenerListaPaginada())
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    @onclick="@(() => IrAPaginaSiguiente(ObtenerListaPaginada()))"
                                    disabled="@(_paginaActual >= ObtenerTotalPaginas(ObtenerListaPaginada()))">
                                Siguiente
                            </button>
                        </div>
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalSolicitudes">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    private PacienteDto? _pacienteSeleccionado;
    private bool _cargando = true;
    private bool _mostrarInfoPaciente = false;
    private bool _mostrarAlertasClinicas = false;
    private bool _mostrarSolicitudes = false;
    private bool _cargandoSolicitudes = false;
    private bool _cargandoSolicitudesRecientes = false;
    private List<SolicitudRecienteDto>? _solicitudesRecientes;

    private List<SolicitudDto>? _solicitudesPendientes;
    private List<SolicitudDto>? _solicitudesPriorizadas;
    private List<SolicitudDto>? _solicitudesEgresadas;

    private int _paginaActual = 1;
    private int _itemsPorPagina = 5;

    private int _solicitudesActivas = 0;
    private int _pendientesPriorizacion = 0;
    private int _datosIncompletos = 0;
    private int _duplicadosDenegados = 0;

    // ========== NUEVAS VARIABLES PARA PROFESIONALES ==========
    private ProfesionalDto? _profesionalSeleccionado;
    private List<ProfesionalDto>? _profesionalesCompletos;
    private List<ProfesionalDto>? _profesionalesPaginados;
    private int _paginaActualProfesionales = 1;
    private int _itemsPorPaginaProfesionales = 6; // Máximo 6 filas
    private int _totalProfesionales = 0;
    private int _totalPaginasProfesionales = 0;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"[Dashboard] OnInitializedAsync - Verificando autenticación...");
        Console.WriteLine($"[Dashboard] AuthStateService.IsAuthenticated: {AuthStateService.IsAuthenticated}");
        Console.WriteLine($"[Dashboard] AuthStateService.Username: {AuthStateService.Username}");
        Console.WriteLine($"[Dashboard] AuthStateService.Role: {AuthStateService.Role}");
        
        if (!AuthStateService.IsAuthenticated)
        {
            Console.WriteLine("[Dashboard] Usuario NO autenticado, redirigiendo a /login");
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        Console.WriteLine("[Dashboard] Usuario autenticado correctamente, cargando datos...");

        await Task.WhenAll(
            CargarProfesionales(),
            CargarMetricasKPI(),
            CargarSolicitudesRecientes()
        );
    }

    private async Task CargarMetricasKPI()
    {
        try
        {
            var activasResponse = await Http.GetAsync("https://localhost:7032/api/Solicitud/pendientes-reales");
            if (activasResponse.IsSuccessStatusCode)
            {
                var json = await activasResponse.Content.ReadAsStringAsync();
                var content = System.Text.Json.JsonSerializer.Deserialize<List<SolicitudMedicoDto>>(json);
                _solicitudesActivas = content?.Count ?? 0;
            }

            // CORREGIDO: Usar el servicio PriorizacionApi que ya está inyectado
            var pendientes = await PriorizacionApi.GetPendientesAsync();
            _pendientesPriorizacion = pendientes?.Count ?? 0;

            var incompletasResponse = await Http.GetAsync("https://localhost:7032/api/Solicitud/incompletas/contar");
            if (incompletasResponse.IsSuccessStatusCode)
            {
                var json = await incompletasResponse.Content.ReadAsStringAsync();
                using var doc = System.Text.Json.JsonDocument.Parse(json);
                if (doc.RootElement.TryGetProperty("cantidad", out var cantidadElement))
                {
                    _datosIncompletos = cantidadElement.GetInt32();
                }
            }

            var duplicadosResponse = await Http.GetAsync("https://localhost:7032/api/Solicitud/duplicados/contar");
            if (duplicadosResponse.IsSuccessStatusCode)
            {
                var json = await duplicadosResponse.Content.ReadAsStringAsync();
                using var doc = System.Text.Json.JsonDocument.Parse(json);
                if (doc.RootElement.TryGetProperty("cantidad", out var cantidadElement))
                {
                    _duplicadosDenegados = cantidadElement.GetInt32();
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error CargarMetricasKPI: {ex.Message}");
        }
    }

    private async Task RenderizarGraficoSolicitudesRecientes()
    {
        try
        {
            Console.WriteLine("[Dashboard] Intentando renderizar gráfico de solicitudes recientes...");
            
            if (_solicitudesRecientes == null || !_solicitudesRecientes.Any())
            {
                Console.WriteLine("[Dashboard] No hay solicitudes recientes, mostrando gráfico vacío");
                
                // Mostrar gráfico vacío con mensaje
                await JS.InvokeVoidAsync("dashboardCharts.renderBar", 
                    "chartSolicitudesRecientes", 
                    new[] { "Sin datos" }, 
                    new[] { 0 }, 
                    new 
                    { 
                        label = "Solicitudes Ingresadas",
                        backgroundColor = "rgba(200, 200, 200, 0.3)",
                        borderColor = "rgba(200, 200, 200, 1)",
                        borderWidth = 1
                    });
                return;
            }

            Console.WriteLine($"[Dashboard] Procesando {_solicitudesRecientes.Count} solicitudes");

            // Agrupar por día y contar
            var solicitudesPorDia = _solicitudesRecientes
                .GroupBy(s => s.FechaCreacion.Date)
                .OrderBy(g => g.Key)
                .Select(g => new
                {
                    Fecha = g.Key,
                    Cantidad = g.Count()
                })
                .ToList();

            var labels = solicitudesPorDia.Select(x => x.Fecha.ToString("ddd dd/MM")).ToArray();
            var data = solicitudesPorDia.Select(x => x.Cantidad).ToArray();

            Console.WriteLine($"[Dashboard] Renderizando gráfico con {solicitudesPorDia.Count} días");

            await JS.InvokeVoidAsync("dashboardCharts.renderBar", 
                "chartSolicitudesRecientes", 
                labels, 
                data, 
                new 
                { 
                    label = "Solicitudes Ingresadas",
                    backgroundColor = "rgba(75, 192, 192, 0.6)",
                    borderColor = "rgba(75, 192, 192, 1)",
                    borderWidth = 2
                });
            
            Console.WriteLine("[Dashboard] Gráfico renderizado exitosamente");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error renderizando gráfico solicitudes recientes: {ex.Message}");
        }
    }

    // ========== MÉTODOS PARA PROFESIONALES ==========
    
    private async Task CargarProfesionales()
    {
        try
        {
            _cargando = true;
            
            // Cargar profesionales desde el nuevo servicio
            _profesionalesCompletos = await ProfesionalApi.GetProfesionalesAsync();
            
            if (_profesionalesCompletos != null && _profesionalesCompletos.Any())
            {
                _totalProfesionales = _profesionalesCompletos.Count;
                _totalPaginasProfesionales = (int)Math.Ceiling((double)_totalProfesionales / _itemsPorPaginaProfesionales);
                ActualizarPaginaProfesionales();
            }
            else
            {
                _profesionalesCompletos = new List<ProfesionalDto>();
                _profesionalesPaginados = new List<ProfesionalDto>();
                _totalProfesionales = 0;
                _totalPaginasProfesionales = 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando profesionales: {ex.Message}");
            _profesionalesCompletos = new List<ProfesionalDto>();
            _profesionalesPaginados = new List<ProfesionalDto>();
        }
        finally
        {
            _cargando = false;
            StateHasChanged();
        }
    }

    private void HandleProfesionalSeleccionado(ProfesionalDto? profesional)
    {
        _profesionalSeleccionado = profesional;
        
        if (profesional != null)
        {
            Console.WriteLine($"[Dashboard] Profesional seleccionado: {profesional.NombreCompleto} - RUT: {profesional.RutCompleto}");
            
            // Resaltar el profesional en la tabla (buscar en la lista completa)
            var indexEnListaCompleta = _profesionalesCompletos?.FindIndex(p => p.Id == profesional.Id) ?? -1;
            
            if (indexEnListaCompleta >= 0)
            {
                // Calcular en qué página está
                _paginaActualProfesionales = (indexEnListaCompleta / _itemsPorPaginaProfesionales) + 1;
                ActualizarPaginaProfesionales();
            }
        }
        
        StateHasChanged();
    }

    private void ActualizarPaginaProfesionales()
    {
        if (_profesionalesCompletos == null || !_profesionalesCompletos.Any())
        {
            _profesionalesPaginados = new List<ProfesionalDto>();
            return;
        }

        _profesionalesPaginados = _profesionalesCompletos
            .Skip((_paginaActualProfesionales - 1) * _itemsPorPaginaProfesionales)
            .Take(_itemsPorPaginaProfesionales)
            .ToList();
    }

    private void PaginaAnteriorProfesionales()
    {
        if (_paginaActualProfesionales > 1)
        {
            _paginaActualProfesionales--;
            ActualizarPaginaProfesionales();
            StateHasChanged();
        }
    }

    private void PaginaSiguienteProfesionales()
    {
        if (_paginaActualProfesionales < _totalPaginasProfesionales)
        {
            _paginaActualProfesionales++;
            ActualizarPaginaProfesionales();
            StateHasChanged();
        }
    }

    // ========== MÉTODOS PARA SOLICITUDES RECIENTES ==========
    
    private async Task CargarSolicitudesRecientes()
    {
        try
        {
            _cargandoSolicitudesRecientes = true;
            Console.WriteLine("[Dashboard] Cargando solicitudes recientes...");

            _solicitudesRecientes = await SolicitudApi.GetSolicitudesRecientesAsync();

            Console.WriteLine($"[Dashboard] Solicitudes recientes cargadas: {_solicitudesRecientes?.Count ?? 0}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando solicitudes recientes: {ex.Message}");
            _solicitudesRecientes = new List<SolicitudRecienteDto>();
        }
        finally
        {
            _cargandoSolicitudesRecientes = false;
            StateHasChanged();
            
            // Renderizar el gráfico después de un pequeño delay para asegurar que el DOM está listo
            await Task.Delay(100);
            await RenderizarGraficoSolicitudesRecientes();
        }
    }

    // ========== MÉTODOS PARA PACIENTES ==========

    private void HandlePacienteSeleccionado(PacienteDto? paciente)
    {
        _pacienteSeleccionado = paciente;
        _mostrarInfoPaciente = false;
        _mostrarAlertasClinicas = false;
        _mostrarSolicitudes = false;
        _paginaActual = 1;

        _solicitudesPendientes = null;
        _solicitudesPriorizadas = null;
        _solicitudesEgresadas = null;

        StateHasChanged();
    }

    private void AbrirModalInfoPaciente()
    {
        if (_pacienteSeleccionado != null)
        {
            _mostrarInfoPaciente = true;
            StateHasChanged();
        }
    }

    private void AbrirModalAlertasClinicas()
    {
        if (_pacienteSeleccionado != null)
        {
            _mostrarAlertasClinicas = true;
            StateHasChanged();
        }
    }

    private async Task AbrirModalSolicitudes()
    {
        if (_pacienteSeleccionado != null)
        {
            _mostrarSolicitudes = true;
            _cargandoSolicitudes = true;
            _paginaActual = 1;
            StateHasChanged();

            await CargarSolicitudesPaciente();
            _cargandoSolicitudes = false;
            StateHasChanged();
        }
    }

    private void CerrarModalInfoPaciente()
    {
        _mostrarInfoPaciente = false;
        StateHasChanged();
    }

    private void CerrarModalAlertasClinicas()
    {
        _mostrarAlertasClinicas = false;
        StateHasChanged();
    }

    private void CerrarModalSolicitudes()
    {
        _mostrarSolicitudes = false;
        StateHasChanged();
    }

    private async Task CargarSolicitudesPaciente()
    {
        try
        {
            if (_pacienteSeleccionado == null)
                return;

            Console.WriteLine($"CargarSolicitudesPaciente: Iniciando para paciente {_pacienteSeleccionado.PrimerNombre} {_pacienteSeleccionado.ApellidoPaterno}");
            
            var pendientes = await PriorizacionApi.GetPendientesAsync() ?? new List<PriorizacionApiService.SolicitudMedicoDto>();
            var priorizadas = await PriorizacionApi.GetPriorizadasAsync() ?? new List<PriorizacionApiService.SolicitudMedicoDto>();

            Console.WriteLine($"CargarSolicitudesPaciente: Pendientes totales: {pendientes.Count}, Priorizadas totales: {priorizadas.Count}");

            var rutFull = _pacienteSeleccionado.RutCompleto;
            Console.WriteLine($"CargarSolicitudesPaciente: Filtrando por RUT: {rutFull}");

            var pendientesFiltradas = pendientes.Where(s => s.Rut == rutFull).ToList();
            var priorizadasFiltradas = priorizadas.Where(s => s.Rut == rutFull).ToList();

            Console.WriteLine($"CargarSolicitudesPaciente: Después de filtro - Pendientes: {pendientesFiltradas.Count}, Priorizadas: {priorizadasFiltradas.Count}");

            _solicitudesPendientes = pendientesFiltradas
                .OrderByDescending(s => s.FechaCreacion)
                .Select(s => new SolicitudDto
                {
                    Id = s.Id,
                    Rut = s.Rut,
                    Procedimiento = s.Procedimiento,
                    Diagnostico = s.Diagnostico,
                    Estado = s.Estado,
                    Prioridad = s.Prioridad,
                    FechaCreacion = s.FechaCreacion
                })
                .ToList();

            _solicitudesPriorizadas = priorizadasFiltradas
                .OrderByDescending(s => s.FechaCreacion)
                .Select(s => new SolicitudDto
                {
                    Id = s.Id,
                    Rut = s.Rut,
                    Procedimiento = s.Procedimiento,
                    Diagnostico = s.Diagnostico,
                    Estado = s.Estado,
                    Prioridad = s.Prioridad,
                    FechaCreacion = s.FechaCreacion
                })
                .ToList();

            _solicitudesEgresadas = new List<SolicitudDto>();

            Console.WriteLine($"CargarSolicitudesPaciente: Datos cargados exitosamente");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CargarSolicitudesPaciente Error: {ex.Message}");
            Console.WriteLine($"CargarSolicitudesPaciente StackTrace: {ex.StackTrace}");
            _solicitudesPendientes = new List<SolicitudDto>();
            _solicitudesPriorizadas = new List<SolicitudDto>();
            _solicitudesEgresadas = new List<SolicitudDto>();
        }
    }

    private List<SolicitudDto> ObtenerSolicitudesActuales(List<SolicitudDto>? lista)
    {
        if (lista == null || !lista.Any())
            return new List<SolicitudDto>();

        var totalPaginas = ObtenerTotalPaginas(lista);
        _paginaActual = Math.Max(1, Math.Min(_paginaActual, totalPaginas));

        return lista
            .Skip((_paginaActual - 1) * _itemsPorPagina)
            .Take(_itemsPorPagina)
            .ToList();
    }

    private List<SolicitudDto> ObtenerListaPaginada()
    {
        if (_solicitudesPendientes?.Any() == true)
            return _solicitudesPendientes;
        if (_solicitudesPriorizadas?.Any() == true)
            return _solicitudesPriorizadas;
        return _solicitudesEgresadas ?? new List<SolicitudDto>();
    }

    private int ObtenerTotalPaginas(List<SolicitudDto>? lista)
    {
        if (lista == null || !lista.Any())
            return 1;
        return (int)Math.Ceiling((double)lista.Count / _itemsPorPagina);
    }

    private void IrAPaginaAnterior()
    {
        if (_paginaActual > 1)
            _paginaActual--;
        StateHasChanged();
    }

    private void IrAPaginaSiguiente(List<SolicitudDto>? lista)
    {
        var totalPaginas = ObtenerTotalPaginas(lista);
        if (_paginaActual < totalPaginas)
            _paginaActual++;
        StateHasChanged();
    }

    private void IrAlDashboardAnalítico()
    {
        Navigation.NavigateTo("/dashboard_verdadero");
    }

    private void IrAlHistorialLogs()
    {
        Navigation.NavigateTo("/historial-priorizaciones");
    }

    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var today = DateTime.Today;
        var age = today.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > today.AddYears(-age)) age--;
        return age;
    }

    // ========== CLASES DTOs ==========

    public class SolicitudDto
    {
        public int Id { get; set; }
        public string? Rut { get; set; } = string.Empty;
        public string? Procedimiento { get; set; } = string.Empty;
        public string? Diagnostico { get; set; } = string.Empty;
        public string? Estado { get; set; } = string.Empty;
        public int? Prioridad { get; set; }
        public DateTime FechaCreacion { get; set; }
    }
}
