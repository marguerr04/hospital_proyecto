@page "/dashboard"
@using proyecto_hospital_version_1.Shared
@using proyecto_hospital_version_1.Components.Shared
@using proyecto_hospital_version_1.Data._Legacy
@inject HospitalDbContextLegacy HospitalDb
@inject NavigationManager Navigation
@inject HttpClient Http
@using Hospital.Api.DTOs

<PageTitle>Panel de Trabajo Quirúrgico</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1 class="h3 mb-0">Panel de Trabajo Quirúrgico</h1>
        </div>
    </div>

    <!-- BOTÓN ROJO PARA DASHBOARD ANALÍTICO -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-3">
                    <button class="btn btn-danger btn-lg w-100 d-flex align-items-center justify-content-center"
                            style="height: 60px; font-size: 1.1rem; font-weight: 600;"
                            onclick="@(() => Navigation.NavigateTo("/dashboard_verdadero"))">
                        <i class="bi bi-graph-up-arrow me-2" style="font-size: 1.3rem;"></i>
                        IR A DASHBOARD ANALÍTICO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DE PROFESIONALES -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-3">
                    <h5 class="card-title mb-3">Profesionales Médicos</h5>

                    @if (_profesionales?.Any() == true)
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Nombre Completo</th>
                                        <th>RUT</th>
                                        <th>Rol</th>
                                        <th>Especialidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var profesional in _profesionales)
                                    {
                                        <tr>
                                            <td>@profesional.NombreCompleto</td>
                                            <td>@profesional.RutCompleto</td>
                                            <td>@profesional.Rol</td>
                                            <td>@profesional.Especialidad</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else if (_cargando)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 mb-0">Cargando profesionales...</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No se encontraron profesionales.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVA DISTRIBUCIÓN: BUSCADOR A LA IZQUIERDA, INFO A LA DERECHA -->
    <div class="row" style="align-items: flex-start;">
        <!-- BUSCADOR DE PACIENTES - COLUMNA IZQUIERDA (4 columnas) -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0" style="height: fit-content;">
                <div class="card-body p-3">
                    <h5 class="card-title mb-3">Buscar Paciente</h5>
                    <div>
                        <BuscadorPaciente OnPacienteEncontrado="HandlePacienteSeleccionado" />
                    </div>
                </div>
            </div>
        </div>

        <!-- INFORMACIÓN DEL PACIENTE - COLUMNA DERECHA (8 columnas) -->
        <div class="col-lg-8">
            @if (_pacienteSeleccionado != null)
            {
                <!-- RESUMEN RÁPIDO DEL PACIENTE -->
                <div class="card shadow-sm border-info mb-3">
                    <div class="card-body p-3">
                        <h6 class="card-title text-info mb-2">
                            <i class="bi bi-person-circle me-2"></i>
                            Resumen del Paciente
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1 small"><strong>Nombre:</strong> @_pacienteSeleccionado.PrimerNombre @_pacienteSeleccionado.ApellidoPaterno</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1 small"><strong>RUT:</strong> @_pacienteSeleccionado.Rut-@_pacienteSeleccionado.Dv</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1 small"><strong>Edad:</strong> @CalcularEdad(_pacienteSeleccionado.FechaNacimiento) años</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <!-- INFORMACIÓN DEL PACIENTE SELECCIONADO - CON BORDE AZUL Y CLICK -->
                    <div class="col-12">
                        <div class="card shadow-sm border-primary" style="border-width: 2px; cursor: pointer;"
                             @onclick="AbrirModalInfoPaciente">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0 text-primary">
                                        <i class="bi bi-person-badge me-2"></i>
                                        Información del Paciente
                                    </h5>
                                    <i class="bi bi-chevron-down text-primary"></i>
                                </div>
                                <p class="text-muted mb-0 mt-1 small">Haz clic para ver detalles completos</p>
                            </div>
                        </div>
                    </div>

                    <!-- ALERTAS CLÍNICAS DEL PACIENTE - CON BORDE ROJO Y CLICK -->
                    <div class="col-12">
                        <div class="card shadow-sm border-danger" style="border-width: 2px; cursor: pointer;"
                             @onclick="AbrirModalAlertasClinicas">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0 text-danger">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        Alertas Clínicas
                                    </h5>
                                    <i class="bi bi-chevron-down text-danger"></i>
                                </div>
                                <p class="text-muted mb-0 mt-1 small">Haz clic para ver alertas importantes</p>
                            </div>
                        </div>
                    </div>

                    <!-- SOLICITUDES QUIRÚRGICAS - CON BORDE VERDE Y CLICK -->
                    <div class="col-12">
                        <div class="card shadow-sm border-success" style="border-width: 2px; cursor: pointer;"
                             @onclick="AbrirModalSolicitudes">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0 text-success">
                                        <i class="bi bi-clipboard2-pulse me-2"></i>
                                        Solicitudes Quirúrgicas
                                    </h5>
                                    <i class="bi bi-chevron-down text-success"></i>
                                </div>
                                <p class="text-muted mb-0 mt-1 small">Haz clic para ver solicitudes del paciente</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm border-0" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                    <div class="card-body text-center">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-search me-2"></i>
                            No se ha seleccionado ningún paciente. Use el buscador para iniciar.
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL PARA INFORMACIÓN DEL PACIENTE -->
@if (_mostrarInfoPaciente && _pacienteSeleccionado != null)
{
    <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
    <div class="modal fade show d-block" style="z-index: 1055;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-badge me-2"></i>
                        Información Completa del Paciente
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalInfoPaciente"></button>
                </div>
                <div class="modal-body">
                    @if (_pacienteSeleccionado != null)
                    {
                        <InfoPacienteCard Paciente="_pacienteSeleccionado" />
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalInfoPaciente">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- MODAL PARA ALERTAS CLÍNICAS -->
@if (_mostrarAlertasClinicas && _pacienteSeleccionado != null)
{
    <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
    <div class="modal fade show d-block" style="z-index: 1055;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Alertas Clínicas del Paciente
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalAlertasClinicas"></button>
                </div>
                <div class="modal-body">
                    @if (_pacienteSeleccionado != null)
                    {
                        <AlertasClinicasCard Paciente="_pacienteSeleccionado" />
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalAlertasClinicas">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- MODAL PARA SOLICITUDES QUIRÚRGICAS -->
@if (_mostrarSolicitudes && _pacienteSeleccionado != null)
{
    <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
    <div class="modal fade show d-block" style="z-index: 1055; max-height: 90vh; overflow: hidden;" tabindex="-1">
        <div class="modal-dialog modal-xl" style="max-height: 85vh;">
            <div class="modal-content" style="max-height: 85vh;">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-clipboard2-pulse me-2"></i>
                        Solicitudes Quirúrgicas - @_pacienteSeleccionado.PrimerNombre @_pacienteSeleccionado.ApellidoPaterno
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalSolicitudes"></button>
                </div>
                <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">

                    @if (_cargandoSolicitudes)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando solicitudes...</p>
                        </div>
                    }
                    else if (_solicitudesPendientes?.Any() == true || _solicitudesPriorizadas?.Any() == true || _solicitudesEgresadas?.Any() == true)
                    {
                        <!-- SECCIÓN 1: SOLICITUDES PRIORIZADAS -->
                        @if (_solicitudesPriorizadas?.Any() == true)
                        {
                            <div class="card shadow-sm border-success mb-4">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Solicitudes Priorizadas
                                    </h6>
                                    <span class="badge bg-light text-dark">@_solicitudesPriorizadas.Count</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Procedimiento</th>
                                                    <th>Diagnóstico</th>
                                                    <th>Prioridad</th>
                                                    <th>Fecha</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var solicitud in _solicitudesPriorizadas.Take(5))
                                                {
                                                    <tr>
                                                        <td class="fw-bold">@solicitud.Id</td>
                                                        <td>@solicitud.Procedimiento</td>
                                                        <td>@solicitud.Diagnostico</td>
                                                        <td>
                                                            @if (solicitud.Prioridad == 1)
                                                            {
                                                                <span class="badge bg-danger">P1</span>
                                                            }
                                                            else if (solicitud.Prioridad == 2)
                                                            {
                                                                <span class="badge bg-warning text-dark">P2</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-primary">P@solicitud.Prioridad</span>
                                                            }
                                                        </td>
                                                        <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    @if (_solicitudesPriorizadas.Count > 5)
                                    {
                                        <div class="card-footer text-center py-2">
                                            <small class="text-muted">Mostrando 5 de @_solicitudesPriorizadas.Count solicitudes priorizadas</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- SECCIÓN 2: SOLICITUDES PENDIENTES -->
                        @if (_solicitudesPendientes?.Any() == true)
                        {
                            <div class="card shadow-sm border-warning mb-4">
                                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-clock me-2"></i>
                                        Solicitudes Pendientes
                                    </h6>
                                    <span class="badge bg-light text-dark">@_solicitudesPendientes.Count</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Procedimiento</th>
                                                    <th>Diagnóstico</th>
                                                    <th>Estado</th>
                                                    <th>Fecha</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var solicitud in _solicitudesPendientes.Take(5))
                                                {
                                                    <tr>
                                                        <td class="fw-bold">@solicitud.Id</td>
                                                        <td>@solicitud.Procedimiento</td>
                                                        <td>@solicitud.Diagnostico</td>
                                                        <td><span class="badge bg-secondary">Pendiente</span></td>
                                                        <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    @if (_solicitudesPendientes.Count > 5)
                                    {
                                        <div class="card-footer text-center py-2">
                                            <small class="text-muted">Mostrando 5 de @_solicitudesPendientes.Count solicitudes pendientes</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- SECCIÓN 3: SOLICITUDES EGRESADAS -->
                        @if (_solicitudesEgresadas?.Any() == true)
                        {
                            <div class="card shadow-sm border-info">
                                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-check2-all me-2"></i>
                                        Solicitudes Egresadas
                                    </h6>
                                    <span class="badge bg-light text-dark">@_solicitudesEgresadas.Count</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Procedimiento</th>
                                                    <th>Diagnóstico</th>
                                                    <th>Estado</th>
                                                    <th>Fecha Egreso</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var solicitud in _solicitudesEgresadas.Take(5))
                                                {
                                                    <tr>
                                                        <td class="fw-bold">@solicitud.Id</td>
                                                        <td>@solicitud.Procedimiento</td>
                                                        <td>@solicitud.Diagnostico</td>
                                                        <td><span class="badge bg-success">Egresado</span></td>
                                                        <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    @if (_solicitudesEgresadas.Count > 5)
                                    {
                                        <div class="card-footer text-center py-2">
                                            <small class="text-muted">Mostrando 5 de @_solicitudesEgresadas.Count solicitudes egresadas</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-clipboard-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No se encontraron solicitudes quirúrgicas para este paciente.</p>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalSolicitudes">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private PacienteDto? _pacienteSeleccionado;
    private List<Profesional>? _profesionales;
    private bool _cargando = true;
    private bool _mostrarInfoPaciente = false;
    private bool _mostrarAlertasClinicas = false;
    private bool _mostrarSolicitudes = false;
    private bool _cargandoSolicitudes = false;

    // Nuevas variables para solicitudes
    private List<SolicitudDto>? _solicitudesPendientes;
    private List<SolicitudDto>? _solicitudesPriorizadas;
    private List<SolicitudDto>? _solicitudesEgresadas;

    protected override async Task OnInitializedAsync()
    {
        await CargarProfesionales();
    }

    private async Task CargarProfesionales()
    {
        try
        {
            _cargando = true;
            _profesionales = await Http.GetFromJsonAsync<List<Profesional>>("http://localhost:5227/api/profesional");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando profesionales: {ex.Message}");
            // Datos de ejemplo si falla la conexión
            _profesionales = new List<Profesional>
            {
                new Profesional { NombreCompleto = "Andrés Felipe Moreno Gutiérrez", RutCompleto = "11223344-5", Rol = "Cirujano Principal", Especialidad = "Solicitante" },
                new Profesional { NombreCompleto = "Valentina Paz Campos Núñez", RutCompleto = "22334455-6", Rol = "Cirujano Principal", Especialidad = "Solicitante" },
                new Profesional { NombreCompleto = "Francisco Javier Bravo Santana", RutCompleto = "33445566-7", Rol = "Cirujano Principal", Especialidad = "Solicitante" }
            };
        }
        finally
        {
            _cargando = false;
            StateHasChanged();
        }
    }

    private void HandlePacienteSeleccionado(PacienteDto? paciente)
    {
        _pacienteSeleccionado = paciente;
        _mostrarInfoPaciente = false;
        _mostrarAlertasClinicas = false;
        _mostrarSolicitudes = false;

        // Limpiar solicitudes anteriores
        _solicitudesPendientes = null;
        _solicitudesPriorizadas = null;
        _solicitudesEgresadas = null;

        StateHasChanged();
    }

    private async Task AbrirModalSolicitudes()
    {
        if (_pacienteSeleccionado != null)
        {
            _mostrarSolicitudes = true;
            _cargandoSolicitudes = true;
            StateHasChanged();

            await CargarSolicitudesPaciente();
            _cargandoSolicitudes = false;
            StateHasChanged();
        }
    }

    private async Task CargarSolicitudesPaciente()
    {
        try
        {
            // Obtener todas las solicitudes del médico (por ahora todas)
            var todasSolicitudes = await Http.GetFromJsonAsync<List<SolicitudDto>>("http://localhost:5227/api/solicitud/medico/1");

            if (todasSolicitudes != null)
            {
                var rutPaciente = $"{_pacienteSeleccionado!.Rut}-{_pacienteSeleccionado.Dv}";

                // Filtrar por el paciente seleccionado
                var solicitudesPaciente = todasSolicitudes
                    .Where(s => s.Rut == rutPaciente)
                    .ToList();

                // Separar por estado
                _solicitudesPendientes = solicitudesPaciente
                    .Where(s => s.Estado == "Pendiente")
                    .Take(5)
                    .ToList();

                _solicitudesPriorizadas = solicitudesPaciente
                    .Where(s => s.Estado == "Priorizada")
                    .Take(5)
                    .ToList();

                // Para egresadas, usar un estado diferente o lógica específica
                _solicitudesEgresadas = solicitudesPaciente
                    .Where(s => s.Estado == "Egresada" || s.Estado == "Completada")
                    .Take(5)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando solicitudes: {ex.Message}");
            // Datos de ejemplo si falla la API
            _solicitudesPendientes = new List<SolicitudDto>
            {
                new SolicitudDto { Id = 1, Procedimiento = "Cirugía de Cadera", Diagnostico = "Artrosis", Estado = "Pendiente", FechaCreacion = DateTime.Now.AddDays(-2) },
                new SolicitudDto { Id = 2, Procedimiento = "Artroscopía Rodilla", Diagnostico = "Lesión Meniscal", Estado = "Pendiente", FechaCreacion = DateTime.Now.AddDays(-5) }
            };
            _solicitudesPriorizadas = new List<SolicitudDto>
            {
                new SolicitudDto { Id = 3, Procedimiento = "Colecistectomía", Diagnostico = "Colelitiasis", Estado = "Priorizada", Prioridad = 1, FechaCreacion = DateTime.Now.AddDays(-1) }
            };
        }
    }

    private void AbrirModalInfoPaciente()
    {
        if (_pacienteSeleccionado != null)
        {
            _mostrarInfoPaciente = true;
            StateHasChanged();
        }
    }

    private void AbrirModalAlertasClinicas()
    {
        if (_pacienteSeleccionado != null)
        {
            _mostrarAlertasClinicas = true;
            StateHasChanged();
        }
    }

    private void CerrarModalInfoPaciente()
    {
        _mostrarInfoPaciente = false;
        StateHasChanged();
    }

    private void CerrarModalAlertasClinicas()
    {
        _mostrarAlertasClinicas = false;
        StateHasChanged();
    }

    private void CerrarModalSolicitudes()
    {
        _mostrarSolicitudes = false;
        StateHasChanged();
    }

    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var today = DateTime.Today;
        var age = today.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > today.AddYears(-age)) age--;
        return age;
    }

    // CLASE INTERNA para mapear la respuesta de profesionales
    public class Profesional
    {
        public int Id { get; set; }
        public string NombreCompleto { get; set; } = string.Empty;
        public string RutCompleto { get; set; } = string.Empty;
        public string Rol { get; set; } = string.Empty;
        public string Especialidad { get; set; } = string.Empty;
    }

    // CLASE INTERNA para mapear solicitudes
    public class SolicitudDto
    {
        public int Id { get; set; }
        public string Rut { get; set; } = string.Empty;
        public string Procedimiento { get; set; } = string.Empty;
        public string Diagnostico { get; set; } = string.Empty;
        public string Estado { get; set; } = string.Empty;
        public int Prioridad { get; set; }
        public DateTime FechaCreacion { get; set; }
    }
}