@page "/dashboard"
@using proyecto_hospital_version_1.Shared
@using proyecto_hospital_version_1.Components.Shared
@using proyecto_hospital_version_1.Data._Legacy
@inject HospitalDbContextLegacy HospitalDb
@inject NavigationManager Navigation

<PageTitle>Panel de Trabajo Quirúrgico</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">Panel de Trabajo Quirúrgico</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <!-- BUSCADOR DE PACIENTES -->
            <div class="widget-card mb-4">
                <h5 class="card-title mb-3">Buscar Paciente</h5>
                <div class="mb-4">
                    <BuscadorPaciente OnPacienteEncontrado="HandlePacienteSeleccionado" />
                </div>
            </div>

            @if (_pacienteSeleccionado != null)
            {
                <div class="row">
                    <!-- INFORMACIÓN DEL PACIENTE SELECCIONADO -->
                    <div class="col-lg-6">
                        <div class="widget-card mb-4">
                            <h5 class="card-title mb-3">Información del Paciente</h5>
                            <div class="mb-4">
                                <InfoPacienteCard Paciente="_pacienteSeleccionado" />
                            </div>
                        </div>
                    </div>

                    <!-- ALERTAS CLÍNICAS DEL PACIENTE -->
                    <div class="col-lg-6">
                        <div class="widget-card mb-4">
                            <h5 class="card-title mb-3">Alertas Clínicas</h5>
                            <div class="mb-4">
                                <AlertasClinicasCard Paciente="_pacienteSeleccionado" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RESUMEN SIMPLE DEL PACIENTE -->
                <div class="widget-card mb-4">
                    <h5 class="card-title mb-3">Resumen del Paciente</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Nombre:</strong> @_pacienteSeleccionado.primerNombre @_pacienteSeleccionado.apellidoPaterno</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>RUT:</strong> @_pacienteSeleccionado.rut-@_pacienteSeleccionado.dv</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Edad:</strong> @CalcularEdad(_pacienteSeleccionado.fechaNacimiento) años</p>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="widget-card">
                    <div class="alert alert-info text-center">
                        <i class="bi bi-search me-2"></i>
                        No se ha seleccionado ningún paciente. Use el buscador para iniciar.
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private PacienteHospital? _pacienteSeleccionado;

    private void HandlePacienteSeleccionado(PacienteHospital? paciente)
    {
        _pacienteSeleccionado = paciente;
        StateHasChanged();
    }

    private int CalcularEdad(DateTime fechaNacimiento)
    {
        var today = DateTime.Today;
        var age = today.Year - fechaNacimiento.Year;
        if (fechaNacimiento.Date > today.AddYears(-age)) age--;
        return age;
    }
}