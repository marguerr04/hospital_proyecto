@using Hospital.Api.DTOs
@using proyecto_hospital_version_1.Services
@inject IProfesionalApiService ProfesionalApi

<div class="row g-2 align-items-end">
    <div class="col-md-5">
        <label class="form-label fw-semibold small">RUT (sin puntos)</label>
        <input type="text" 
               class="form-control form-control-sm" 
               placeholder="12345678"
               @bind="_rutBusqueda" 
               @bind:event="oninput"
               @oninput="RutInputChanged"
               @onkeypress="OnKeyPress" />
    </div>
    <div class="col-md-2">
        <label class="form-label fw-semibold small">DV</label>
        <input type="text" 
               class="form-control form-control-sm text-center text-uppercase"
               placeholder="K"
               maxlength="1" 
               @bind="_dvBusqueda" 
               @bind:event="oninput"
               @onkeypress="OnKeyPress"
               style="text-transform: uppercase;" />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary btn-sm w-100" 
                @onclick="Buscar"
                disabled="@_buscando">
            @if (_buscando)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
            }
            <span>Buscar</span>
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary btn-sm w-100" 
                @onclick="Limpiar"
                disabled="@_buscando">
            Limpiar
        </button>
    </div>
</div>

@if (!string.IsNullOrEmpty(_mensajeBusqueda))
{
    <div class="alert @(_profesionalEncontrado ? "alert-success" : "alert-warning") alert-sm mt-2 mb-0 py-2">
        <small>
            <i class="bi @(_profesionalEncontrado ? "bi-check-circle" : "bi-exclamation-triangle") me-1"></i>
            @_mensajeBusqueda
        </small>
    </div>
}

@code {
    [Parameter]
    public EventCallback<ProfesionalDto?> OnProfesionalEncontrado { get; set; }
    
    [Parameter]
    public EventCallback<string> OnRutCambiado { get; set; }

    private string _rutBusqueda = "";
    private string _dvBusqueda = "";
    private string _mensajeBusqueda = "";
    private bool _profesionalEncontrado = false;
    private bool _buscando = false;

    private async Task Buscar()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_rutBusqueda))
            {
                _mensajeBusqueda = "Por favor ingrese un RUT";
                _profesionalEncontrado = false;
                return;
            }

            _buscando = true;
            _mensajeBusqueda = "Buscando profesional...";
            StateHasChanged();

            // Buscar profesional por RUT
            var profesional = await ProfesionalApi.BuscarPorRutAsync(_rutBusqueda);

            if (profesional != null)
            {
                _profesionalEncontrado = true;
                _mensajeBusqueda = $"Profesional encontrado: {profesional.NombreCompleto}";
                await OnProfesionalEncontrado.InvokeAsync(profesional);
            }
            else
            {
                _profesionalEncontrado = false;
                _mensajeBusqueda = "Profesional no encontrado con ese RUT";
                await OnProfesionalEncontrado.InvokeAsync(null);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en búsqueda: {ex.Message}");
            _mensajeBusqueda = "Error al buscar profesional";
            _profesionalEncontrado = false;
            await OnProfesionalEncontrado.InvokeAsync(null);
        }
        finally
        {
            _buscando = false;
            StateHasChanged();
        }
    }

    private async Task Limpiar()
    {
        _rutBusqueda = "";
        _dvBusqueda = "";
        _mensajeBusqueda = "";
        _profesionalEncontrado = false;
        await OnProfesionalEncontrado.InvokeAsync(null);
        await OnRutCambiado.InvokeAsync("");
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Buscar();
        }
    }

    private async Task RutInputChanged(ChangeEventArgs e)
    {
        _rutBusqueda = e.Value?.ToString() ?? "";
        await OnRutCambiado.InvokeAsync(_rutBusqueda);
        
        if (string.IsNullOrWhiteSpace(_rutBusqueda))
        {
            _mensajeBusqueda = "";
            _profesionalEncontrado = false;
        }
    }
}
