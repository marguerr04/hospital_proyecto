# Arquitectura y Diseño del Sistema - Sistema de Gestión Hospitalaria

## Tabla de Contenidos
1. [Arquitectura General](#arquitectura-general)
2. [Justificación de la Arquitectura](#justificación-de-la-arquitectura)
3. [Componentes y Módulos del Sistema](#componentes-y-módulos-del-sistema)
4. [Herramientas y Tecnologías](#herramientas-y-tecnologías)
5. [Diagrama de Flujo](#diagrama-de-flujo)

---

## Arquitectura General

### Patrón Arquitectónico: **Cliente-Servidor con Arquitectura en Capas**

El sistema implementa una arquitectura **Cliente-Servidor** distribuida en **N capas** (N-Tier Architecture), específicamente:

```
???????????????????????????????????????????????????????????????
?                    CAPA DE PRESENTACIÓN                      ?
?         (Blazor Server - proyecto_hospital_version_1)        ?
???????????????????????????????????????????????????????????????
                       ? HTTP/HTTPS + JWT
                       ?
???????????????????????????????????????????????????????????????
?                  CAPA DE APLICACIÓN (API)                   ?
?              (Hospital.Api - REST Controllers)              ?
?         - Autenticación y Autorización (JWT)               ?
?         - Validación de Datos                               ?
?         - Orquestación de Servicios                         ?
???????????????????????????????????????????????????????????????
                       ? Inyección de Dependencias
                       ?
???????????????????????????????????????????????????????????????
?                    CAPA DE SERVICIOS                        ?
?         - Servicios de Negocio                             ?
?         - Lógica de Dominio                                 ?
?         - Acceso a Datos                                    ?
???????????????????????????????????????????????????????????????
                       ? Entity Framework Core
                       ?
???????????????????????????????????????????????????????????????
?                    CAPA DE DATOS                            ?
?              (SQL Server + Entity Framework)               ?
?         - Base de Datos Relacional                         ?
?         - Entidades y Modelos                              ?
???????????????????????????????????????????????????????????????
```

---

## Justificación de la Arquitectura

### 1. **Separación de Responsabilidades**
- **Capa de Presentación (Blazor)**: Maneja únicamente la interfaz de usuario y experiencia del usuario.
- **Capa de API**: Expone endpoints REST que pueden ser consumidos por múltiples clientes.
- **Capa de Servicios**: Contiene toda la lógica de negocio hospitalaria, independiente de la presentación.
- **Capa de Datos**: Maneja el acceso a la base de datos de forma abstracta.

### 2. **Reutilización de Código**
- Los servicios de negocio pueden ser consumidos por diferentes interfaces (Blazor, aplicaciones móviles, etc.).
- Las DTOs (Data Transfer Objects) encapsulan la transformación de datos entre capas.

### 3. **Testabilidad**
- Cada capa puede ser testeada de forma independiente.
- Los servicios implementan interfaces que facilitan el mocking en pruebas unitarias.

### 4. **Escalabilidad**
- La capa de API puede ser desplegada independientemente.
- La capa de servicios puede ser optimizada sin afectar la presentación.
- Base de datos centralizada permite consistencia de datos.

### 5. **Seguridad**
- **JWT (JSON Web Tokens)** para autenticación stateless.
- **CORS** configurado para controlar acceso desde clientes.
- **HTTPS** para comunicación encriptada.
- **Hash de Contraseñas** con BCrypt.

### 6. **Mantenibilidad**
- Código organizado por funcionalidades y responsabilidades.
- Fácil localización de código relacionado.
- Cambios en la base de datos no afectan la lógica de negocio.

---

## Componentes y Módulos del Sistema

### **PROYECTO 1: Hospital.Api**
*API REST que expone los servicios de negocio hospitalario*

#### **Estructura de Directorios:**

```
Hospital.Api/
??? Controllers/                    # Endpoints REST
?   ??? AuthController              # Autenticación
?   ??? PacienteController          # Gestión de Pacientes
?   ??? SolicitudController         # Solicitudes Quirúrgicas
?   ??? PriorizacionController      # Lógica de Priorización
?   ??? DiagnosticoController       # Diagnósticos
?   ??? ProcedimientoController     # Procedimientos
?   ??? EspecialidadController      # Especialidades
?   ??? AuditoriaPriorizacionController  # Auditoría
?   ??? ConsentimientoInformadoController # Consentimiento
?
??? Data/                           # Acceso a Datos
?   ??? HospitalDbContext.cs        # DbContext principal
?   ??? Entities/                   # Modelos de Datos
?   ?   ??? Paciente.cs
?   ?   ??? SolicitudQuirurgicaReal.cs
?   ?   ??? Diagnostico.cs
?   ?   ??? Procedimiento.cs
?   ?   ??? Profesional.cs
?   ?   ??? Especialidad.cs
?   ?   ??? PriorizacionSolicitud.cs
?   ?   ??? [+35 entidades más]
?   ?
?   ??? Services/                   # Servicios de Acceso a Datos
?       ??? SolicitudQuirurgicaRealService.cs
?       ??? DiagnosticoService.cs
?       ??? ProfesionalService.cs
?       ??? AuditoriaPriorizacionService.cs
?       ??? [Interfaces ISolicitudQuirurgicaService, etc.]
?
??? DTOs/                           # Data Transfer Objects
?   ??? SolicitudMedicoDto.cs
?   ??? PacienteDto.cs
?   ??? DiagnosticoDto.cs
?   ??? ProcedimientoDto.cs
?   ??? AuditoriaPriorizacionDto.cs
?   ??? ConsentimientoInformadoDto.cs
?   ??? [+10 DTOs más]
?
??? Program.cs                      # Configuración de Servicios
??? appsettings.json              # Configuración
```

#### **Responsabilidades Principales:**

| Componente | Función |
|-----------|---------|
| **Controllers** | Reciben solicitudes HTTP, validan parámetros, invocan servicios, retornan respuestas JSON |
| **Services** | Contienen lógica de negocio hospitalaria (validaciones de priorización, cálculos, etc.) |
| **Entities** | Modelos de base de datos con relaciones y restricciones |
| **DTOs** | Transforman datos de entidades en objetos seguros para transmisión |
| **DbContext** | Mapeo de entidades a tablas, gestión de relaciones |

---

### **PROYECTO 2: proyecto_hospital_version_1**
*Aplicación Blazor Server - Interfaz de Usuario*

#### **Estructura de Directorios:**

```
proyecto_hospital_version_1/
??? Components/
?   ??? Pages/                      # Páginas Razor (Vistas)
?   ?   ??? Login.razor             # Autenticación
?   ?   ??? Dashboard.razor         # Panel de Control
?   ?   ??? Dashboard_verdadero.razor # Dashboard Completo
?   ?   ??? PriorizarSolicitud.razor # Priorización
?   ?   ??? Generar_solicitud_medico.razor # Formulario Solicitud
?   ?   ??? HistorialPriorizaciones.razor  # Historial
?   ?   ??? HomeMedico.razor        # Home Médico
?   ?   ??? [+10 páginas más]
?   ?
?   ??? Shared/                     # Componentes Reutilizables
?   ?   ??? BuscadorPaciente.razor  # Control de búsqueda
?   ?   ??? BuscadorProfesional.razor
?   ?   ??? AlertasClinicasCard.razor
?   ?   ??? CriteriosPriorizacion.razor
?   ?   ??? ConsentimientoPDF.razor
?   ?   ??? Footer.razor
?   ?   ??? [Componentes compartidos]
?   ?
?   ??? Layout/                     # Layouts
?   ?   ??? Footer.razor
?   ?
?   ??? App.razor                   # Componente raíz
?
??? Services/                       # Servicios Cliente (API Consumers)
?   ??? AuthStateService.cs         # Estado de Autenticación
?   ??? DashboardService.cs         # Consume DashboardController
?   ??? PacienteApiService.cs       # Consume PacienteController
?   ??? SolicitudQuirurgicaApiService.cs # Consume SolicitudController
?   ??? PriorizacionApiService.cs   # Consume PriorizacionController
?   ??? DiagnosticoService.cs       # Consume DiagnosticoController
?   ??? AuditoriaPriorizacionApiService.cs
?   ??? ConsentimientoInformadoService.cs
?   ??? EspecialidadService.cs
?   ??? [Servicios de consumo de API]
?
??? Data/
?   ??? ApplicationDbContext.cs     # DbContext para Identidad (minimal)
?
??? Helpers/                        # Utilidades
?   ??? [Funciones auxiliares]
?
??? wwwroot/
?   ??? js/
?   ?   ??? interop.js             # Interoperabilidad Blazor-JavaScript
?   ?   ??? dashboard-charts.js    # Gráficos del Dashboard
?   ?
?   ??? css/
?   ?   ??? custom.css             # Estilos personalizados
?   ?   ??? Dashboard.css          # Estilos del Dashboard
?   ?
?   ??? img/                        # Recursos estáticos
?
??? Migrations/                     # Migraciones Entity Framework
?
??? Program.cs                      # Configuración Blazor
??? appsettings.json              # Configuración
??? proyecto_hospital_version_1.csproj # Dependencias
```

#### **Responsabilidades Principales:**

| Componente | Función |
|-----------|---------|
| **Pages** | Componentes Razor que representan pantallas completas de la aplicación |
| **Shared Components** | Componentes reutilizables (botones, formularios, modales, etc.) |
| **Services** | Consumen endpoints de Hospital.Api mediante HttpClient |
| **JavaScript Interop** | Integración con librerías JavaScript (Select2, SweetAlert, Charts) |
| **Styles** | CSS personalizado y diseño responsivo |

---

## Herramientas y Tecnologías

### **Backend (Hospital.Api)**

| Tecnología | Versión | Propósito |
|-----------|---------|----------|
| **.NET** | 8.0 | Framework de desarrollo |
| **ASP.NET Core** | 8.0 | Framework web para API REST |
| **Entity Framework Core** | 8.0 | ORM para acceso a datos |
| **SQL Server** | 2019+ | Base de datos relacional |
| **JWT Bearer** | - | Autenticación sin sesiones (stateless) |
| **BCrypt.Net** | 0.1.1+ | Hash de contraseñas |
| **Swagger/OpenAPI** | 6.4+ | Documentación y prueba de API |
| **CORS** | Built-in | Configuración de acceso desde clientes |

### **Frontend (Blazor Server)**

| Tecnología | Versión | Propósito |
|-----------|---------|----------|
| **.NET** | 8.0 | Framework de desarrollo |
| **Blazor Server** | 8.0 | Framework web interactivo |
| **Razor Components** | - | Componentes UI reutilizables |
| **MudBlazor** | 6.0+ | Componentes Material Design |
| **jQuery** | 3.x | Manipulación del DOM |
| **Select2** | 4.1+ | Búsqueda y selección avanzada |
| **SweetAlert2** | 11+ | Alertas y modales personalizados |
| **Chart.js** | 3.x | Gráficos para dashboard |
| **Bootstrap** | 5.x | Framework CSS responsivo |

### **Bases de Datos**

| Base de Datos | Propósito |
|--------------|----------|
| **HospitalDbContext** | Datos hospitalarios (pacientes, solicitudes, etc.) |
| **ApplicationDbContext** | Identidad y autenticación (minimal) |

### **Patrones de Comunicación**

```
Blazor Client                    Hospital.Api
     ?                               ?
     ?? HTTP/HTTPS ?????????????????? Controllers
     ?                               ?
     ?????? JSON Response ???????????? Services
     ?                               ?
     ?? JWT Token en Headers ????????? (Validación)
```

---

## Diagrama de Flujo de Datos

### **1. Autenticación de Usuario**

```
???????????
? Login   ?
? Blazor  ?
???????????
     ? POST /api/auth/login
     ?
????????????????
? AuthController???????????????????????????
????????????????              ? Valida   ?
     ?                        ? Cred.    ?
     ? JWT Token             ????????????
     ?                           ?
     ?                        Hash BCrypt
     ?                           ?
     ?????????????????????????????
     
Token guardado en SessionStorage/LocalStorage
```

### **2. Búsqueda de Pacientes**

```
????????????????????????
? BuscadorPaciente     ?
? (Componente Blazor)  ?
????????????????????????
          ? PacienteApiService.BuscarAsync()
          ? GET /api/paciente/buscar?cedula=XXX
          ?
????????????????????????????
? PacienteController       ?
????????????????????????????
          ? Inyecta Servicio
          ?
????????????????????????????
? SolicitudQuirurgica      ?
? RealService              ?
????????????????????????????
          ? Consulta BD
          ?
????????????????????????????
? HospitalDbContext        ?
? (Entity Framework)       ?
????????????????????????????
          ?
          ?
????????????????????????????
? SQL Server               ?
? PACIENTE, SOLICITUD_... ?
????????????????????????????
```

### **3. Crear Solicitud Quirúrgica**

```
????????????????????????
? Generar_solicitud    ?
? _medico.razor        ?
????????????????????????
          ? Captura Datos
          ?
????????????????????????????
? Validación Cliente       ?
? (JavaScript + Blazor)    ?
????????????????????????????
          ? SolicitudQuirurgicaApiService
          ? POST /api/solicitud/crear
          ?
????????????????????????????????
? SolicitudController          ?
? - Valida token JWT           ?
? - Valida datos DTO           ?
????????????????????????????????
          ?
          ?
????????????????????????????????
? SolicitudQuirurgicaReal      ?
? Service                      ?
? - Crea registro              ?
? - Asigna estado inicial      ?
? - Registra auditoría         ?
????????????????????????????????
          ?
          ?
????????????????????????????????
? HospitalDbContext.SaveChanges?
????????????????????????????????
          ?
          ?
????????????????????????????????
? SQL Server - Transacción     ?
????????????????????????????????
```

### **4. Priorización de Solicitud**

```
????????????????????????
? PriorizarSolicitud   ?
? .razor               ?
????????????????????????
          ? Selecciona criterios
          ? PriorizacionApiService
          ? POST /api/priorizacion
          ?
????????????????????????????
? PriorizacionController   ?
????????????????????????????
          ?
          ?
????????????????????????????????
? PriorizacionService          ?
? - Calcula puntuación         ?
? - Aplica criterios           ?
? - Determina prioridad        ?
????????????????????????????????
          ?
          ?
????????????????????????????????
? HospitalDbContext            ?
? PRIORIZACION_SOLICITUD       ?
????????????????????????????????
```

---

## Patrones de Diseño Utilizados

### **1. Repository Pattern (Implícito)**
- Entity Framework actúa como repositorio abstracto.
- Los servicios exponen métodos de acceso a datos.

### **2. Service Layer Pattern**
```csharp
Controller ? Service ? Repository/DbContext ? Database
```

### **3. Data Transfer Object (DTO)**
```csharp
Entity (BD) ? DTO (Transferencia) ? JSON (Cliente)
```

### **4. Dependency Injection**
```csharp
builder.Services.AddScoped<SolicitudQuirurgicaRealService>();
builder.Services.AddScoped<IDiagnosticoService, DiagnosticoService>();
```

### **5. Middleware Pattern**
- Authentication Middleware (JWT)
- CORS Middleware
- Error Handling Middleware

---

## Flujo de Seguridad

```
Cliente solicita acceso
        ?
   [HTTPS]
        ?
Login ? Valida credenciales ? Hash con BCrypt
        ?
    Genera JWT
        ?
Cliente almacena JWT
        ?
Próximas solicitudes incluyen JWT en headers
        ?
AuthenticationMiddleware valida JWT
        ?
Middleware valida firma y expiración
        ?
Si válido ? Acceso concedido
Si inválido ? Error 401 Unauthorized
```

---

## Resumen Técnico

| Aspecto | Descripción |
|--------|------------|
| **Patrón Arquitectónico** | N-Tier Client-Server (4 capas) |
| **Comunicación** | REST API con JSON |
| **Autenticación** | JWT Bearer Token |
| **Base de Datos** | SQL Server con EF Core |
| **Frontend** | Blazor Server con componentes interactivos |
| **Validación** | En cliente (JS) y servidor (API) |
| **Escalabilidad** | API stateless, DB centralizada |
| **Mantenibilidad** | Separación clara de responsabilidades |

---

## Ventajas de esta Arquitectura

? **Escalabilidad**: API independiente puede crecer sin limitaciones del frontend  
? **Reusabilidad**: Servicios pueden ser consumidos por múltiples clientes  
? **Testabilidad**: Cada capa aislada facilita pruebas unitarias e integración  
? **Seguridad**: JWT stateless, HTTPS, BCrypt, validación en múltiples capas  
? **Mantenibilidad**: Código organizado por funcionalidad y responsabilidad  
? **Performance**: Caching, validaciones tempranas, DB optimizada  
? **Flexibilidad**: Fácil agregar nuevos endpoints o interfaces  

---

## Posibles Mejoras Futuras

- ?? **Caché Distribuido**: Redis para mejorar performance
- ?? **API Móvil**: Reutilizar servicios con clientes nativos
- ?? **SignalR**: Notificaciones en tiempo real
- ?? **Eventos de Dominio**: CQRS para arquitectura más compleja
- ?? **Cloud**: Migración a Azure App Service + SQL Database
- ?? **Testing**: Implementar suite completa de unit y integration tests

---

**Documento generado**: Sistema de Gestión Hospitalaria  
**Versión**: 1.0  
**Fecha**: 2024
