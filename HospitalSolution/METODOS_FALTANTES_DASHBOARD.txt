// ========== MÉTODOS FALTANTES PARA DASHBOARD.RAZOR ==========
// Estos métodos deben agregarse en la sección @code ANTES de la clase SolicitudDto

private void HandlePacienteSeleccionado(PacienteDto? paciente)
{
    _pacienteSeleccionado = paciente;
    _mostrarInfoPaciente = false;
    _mostrarAlertasClinicas = false;
    _mostrarSolicitudes = false;
    _paginaActual = 1;

    _solicitudesPendientes = null;
    _solicitudesPriorizadas = null;
    _solicitudesEgresadas = null;

    StateHasChanged();
}

private void AbrirModalInfoPaciente()
{
    if (_pacienteSeleccionado != null)
    {
        _mostrarInfoPaciente = true;
        StateHasChanged();
    }
}

private void AbrirModalAlertasClinicas()
{
    if (_pacienteSeleccionado != null)
    {
        _mostrarAlertasClinicas = true;
        StateHasChanged();
    }
}

private async Task AbrirModalSolicitudes()
{
    if (_pacienteSeleccionado != null)
    {
        _mostrarSolicitudes = true;
        _cargandoSolicitudes = true;
        _paginaActual = 1;
        StateHasChanged();

        await CargarSolicitudesPaciente();
        _cargandoSolicitudes = false;
        StateHasChanged();
    }
}

private void CerrarModalInfoPaciente()
{
    _mostrarInfoPaciente = false;
    StateHasChanged();
}

private void CerrarModalAlertasClinicas()
{
    _mostrarAlertasClinicas = false;
    StateHasChanged();
}

private void CerrarModalSolicitudes()
{
    _mostrarSolicitudes = false;
    StateHasChanged();
}

private async Task CargarSolicitudesPaciente()
{
    try
    {
        if (_pacienteSeleccionado == null)
            return;

        Console.WriteLine($"CargarSolicitudesPaciente: Iniciando para paciente {_pacienteSeleccionado.PrimerNombre} {_pacienteSeleccionado.ApellidoPaterno}");
        
        var pendientes = await PriorizacionApi.GetPendientesAsync() ?? new List<PriorizacionApiService.SolicitudMedicoDto>();
        var priorizadas = await PriorizacionApi.GetPriorizadasAsync() ?? new List<PriorizacionApiService.SolicitudMedicoDto>();

        Console.WriteLine($"CargarSolicitudesPaciente: Pendientes totales: {pendientes.Count}, Priorizadas totales: {priorizadas.Count}");

        var rutFull = _pacienteSeleccionado.RutCompleto;
        Console.WriteLine($"CargarSolicitudesPaciente: Filtrando por RUT: {rutFull}");

        var pendientesFiltradas = pendientes.Where(s => s.Rut == rutFull).ToList();
        var priorizadasFiltradas = priorizadas.Where(s => s.Rut == rutFull).ToList();

        Console.WriteLine($"CargarSolicitudesPaciente: Después de filtro - Pendientes: {pendientesFiltradas.Count}, Priorizadas: {priorizadasFiltradas.Count}");

        _solicitudesPendientes = pendientesFiltradas
            .OrderByDescending(s => s.FechaCreacion)
            .Select(s => new SolicitudDto
            {
                Id = s.Id,
                Rut = s.Rut,
                Procedimiento = s.Procedimiento,
                Diagnostico = s.Diagnostico,
                Estado = s.Estado,
                Prioridad = s.Prioridad,
                FechaCreacion = s.FechaCreacion
            })
            .ToList();

        _solicitudesPriorizadas = priorizadasFiltradas
            .OrderByDescending(s => s.FechaCreacion)
            .Select(s => new SolicitudDto
            {
                Id = s.Id,
                Rut = s.Rut,
                Procedimiento = s.Procedimiento,
                Diagnostico = s.Diagnostico,
                Estado = s.Estado,
                Prioridad = s.Prioridad,
                FechaCreacion = s.FechaCreacion
            })
            .ToList();

        _solicitudesEgresadas = new List<SolicitudDto>();

        Console.WriteLine($"CargarSolicitudesPaciente: Datos cargados exitosamente");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"CargarSolicitudesPaciente Error: {ex.Message}");
        Console.WriteLine($"CargarSolicitudesPaciente StackTrace: {ex.StackTrace}");
        _solicitudesPendientes = new List<SolicitudDto>();
        _solicitudesPriorizadas = new List<SolicitudDto>();
        _solicitudesEgresadas = new List<SolicitudDto>();
    }
}

private List<SolicitudDto> ObtenerSolicitudesActuales(List<SolicitudDto>? lista)
{
    if (lista == null || !lista.Any())
        return new List<SolicitudDto>();

    var totalPaginas = ObtenerTotalPaginas(lista);
    _paginaActual = Math.Max(1, Math.Min(_paginaActual, totalPaginas));

    return lista
        .Skip((_paginaActual - 1) * _itemsPorPagina)
        .Take(_itemsPorPagina)
        .ToList();
}

private List<SolicitudDto> ObtenerListaPaginada()
{
    if (_solicitudesPendientes?.Any() == true)
        return _solicitudesPendientes;
    if (_solicitudesPriorizadas?.Any() == true)
        return _solicitudesPriorizadas;
    return _solicitudesEgresadas ?? new List<SolicitudDto>();
}

private int ObtenerTotalPaginas(List<SolicitudDto>? lista)
{
    if (lista == null || !lista.Any())
        return 1;
    return (int)Math.Ceiling((double)lista.Count / _itemsPorPagina);
}

private void IrAPaginaAnterior()
{
    if (_paginaActual > 1)
        _paginaActual--;
    StateHasChanged();
}

private void IrAPaginaSiguiente(List<SolicitudDto>? lista)
{
    var totalPaginas = ObtenerTotalPaginas(lista);
    if (_paginaActual < totalPaginas)
        _paginaActual++;
    StateHasChanged();
}

private void IrAlDashboardAnalítico()
{
    Navigation.NavigateTo("/dashboard_verdadero");
}

private void IrAlHistorialLogs()
{
    Navigation.NavigateTo("/historial-priorizaciones");
}
